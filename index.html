<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Magical Snow Globe AR</title>

  <!-- –°—Ç–∞–±—ñ–ª—å–Ω—ñ –≤–µ—Ä—Å—ñ—ó –±–µ–∑ –∑–∞–π–≤–∏—Ö –ø—Ä–æ–±—ñ–ª—ñ–≤ -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
      touch-action: none;
    }
    .container {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    #ar-container {
      width: 100%;
      height: 100%;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      color: white;
      background: rgba(0,0,0,0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid #4a90e2;
      min-width: 280px;
    }
    .loading h3 {
      margin: 0 0 15px 0;
      color: #4a90e2;
    }
    .loading p {
      margin: 8px 0;
      font-size: 16px;
    }
    .loading .small {
      font-size: 14px;
      color: #ccc;
    }
    .error {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 1001;
      color: red;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 8px;
      display: none;
      border: 1px solid red;
    }
    .music-control {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1002;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      border: 2px solid #4a90e2;
    }
    .music-control:hover {
      background: rgba(74, 144, 226, 0.3);
    }
    .music-control.playing {
      background: rgba(74, 144, 226, 0.5);
    }
  </style>
</head>
<body>
  <div class="error" id="error"></div>
  <button class="music-control" id="musicButton">üîá –£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É</button>

  <div class="loading" id="loading">
    <h3>üîÆ –ú–∞–≥—ñ—á–Ω–∞ –∫—É–ª—è</h3>
    <p><strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞–≥—ñ—á–Ω–æ—ó –∫—É–ª—ñ...</strong></p>
    <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
    <p class="small">–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</p>
    <p class="small">–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥</p>
  </div>

  <div class="container">
    <div id="ar-container">
      <a-scene
        embedded
        mindar-image="imageTargetSrc: ./card.mind; autoStart: true; maxTrack: 1;"
        color-space="sRGB"
        renderer="colorManagement: true;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">

        <!-- –ó–±—ñ–ª—å—à–µ–Ω–æ —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∞—É–¥—ñ–æ -->
        <a-assets timeout="8000">
          <audio id="backgroundMusic" src="./fon1.mp3" preload="auto" crossorigin></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- –ê—É–¥—ñ–æ-—Å—É—Ç–Ω—ñ—Å—Ç—å –±–µ–∑ autoplay/loop -->
        <a-entity id="background-audio" sound="src: #backgroundMusic; volume: 0.5"></a-entity>

        <a-entity mindar-image-target="targetIndex: 0">
          <!-- –ú–∞–≥—ñ—á–Ω–∞ –∫—É–ª—è -->
          <a-sphere
            id="magic-sphere"
            radius="0.4"
            position="0 0.5 0"
            color="#aaddff"
            opacity="0.4"
            transparent="true"
            shader="flat"
            class="clickable">
          </a-sphere>

          <!-- –ü—ñ–¥—Å—Ç–∞–≤–∫–∞ -->
          <a-cylinder
            radius="0.45"
            height="0.05"
            position="0 -0.1 0"
            color="#888888"
            opacity="0.8">
          </a-cylinder>

          <!-- –¢–µ–∫—Å—Ç -->
          <a-text
            id="magic-text"
            value="–¢–æ—Ä–∫–Ω–∏—Å—è –∫—É–ª—ñ!"
            position="0 1.0 0"
            align="center"
            color="#ffffff"
            width="2.5"
            look-at="[camera]">
          </a-text>
        </a-entity>
      </a-scene>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loading = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const musicButton = document.getElementById('musicButton');
      let isMusicPlaying = false;
      let audioEntity = null;
      let isRotating = false;
      let snowflakes = [];
      let snowSystem = null;
      let animationId = null;

      const texts = [
        "–ë–∞–∂–∞—é —É–¥–∞—á—ñ!", "–¢–≤–æ—è –º—Ä—ñ—è –∑–±—É–¥–µ—Ç—å—Å—è", "–ú–∞–≥—ñ—è –ø–æ—Ä—É—á", "–°—è–π —è—Å–∫—Ä–∞–≤—ñ—à–µ",
        "–ú—Ä—ñ–π —Å–º—ñ–ª–∏–≤—ñ—à–µ", "–•–æ–ª–æ–¥–Ω–∞ –ø—Ä–∞–≤–¥–∞", "–ì–∞—Ä—è—á–µ –±–∞–∂–∞–Ω–Ω—è", "–ß–∏—Å—Ç—ñ –¥—É–º–∫–∏",
        "–ó–º—ñ–Ω–Ω–∏–π –≤—ñ—Ç–µ—Ä", "–¢–∞—î–º–Ω–∏—á–∞ –Ω—ñ—á", "–Ø—Å–Ω–∏–π –¥–µ–Ω—å", "–®–≤–∏–¥–∫–∞ –¥—ñ—è",
        "–ß–∞—Ä—ñ–≤–Ω–∞ —Å–∏–ª–∞", "–í—ñ—â—É–π –º–∞–π–±—É—Ç–Ω—î", "–°–≤—è—Ç–∫–æ–≤–∏–π –Ω–∞—Å—Ç—Ä—ñ–π"
      ];
      let currentTextIndex = 0;

      // –ü–æ–∫–∞–∑ –ø–æ–º–∏–ª–∫–∏
      function showError(msg) {
        if (errorEl) {
          errorEl.textContent = `‚ùå ${msg}`;
          errorEl.style.display = 'block';
        }
        console.error(msg);
      }

      // –ö–µ—Ä—É–≤–∞–Ω–Ω—è –º—É–∑–∏–∫–æ—é
      function setupMusicControl() {
        musicButton.addEventListener('click', () => {
          const audioEl = document.getElementById('backgroundMusic');
          if (!audioEntity) {
            audioEntity = document.querySelector('#background-audio');
          }

          if (!audioEl || !audioEntity?.components?.sound) {
            showError('–ê—É–¥—ñ–æ –Ω–µ –≥–æ—Ç–æ–≤–µ. –ó–∞—á–µ–∫–∞–π—Ç–µ...');
            return;
          }

          if (audioEl.readyState < 2) {
            showError('–ú—É–∑–∏–∫–∞ —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...');
            return;
          }

          if (isMusicPlaying) {
            audioEntity.components.sound.stopSound();
            musicButton.textContent = 'üîá –£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É';
            musicButton.classList.remove('playing');
          } else {
            audioEntity.components.sound.playSound();
            musicButton.textContent = 'üîä –í–∏–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É';
            musicButton.classList.add('playing');
          }
          isMusicPlaying = !isMusicPlaying;
        });
      }

      // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–Ω—ñ–∂–∏–Ω–æ–∫ (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ: 25 –∑–∞–º—ñ—Å—Ç—å 40)
      function createSnowflakes() {
        const system = document.createElement('a-entity');
        system.setAttribute('position', '0 0.5 0');
        document.querySelector('a-scene').appendChild(system);
        snowSystem = system;

        for (let i = 0; i < 25; i++) {
          const flake = document.createElement('a-sphere');
          const size = 0.008 + Math.random() * 0.012;
          const x = (Math.random() - 0.5) * 0.6;
          const y = 0.3 + Math.random() * 0.6;
          const z = (Math.random() - 0.5) * 0.6;

          flake.setAttribute('radius', size);
          flake.setAttribute('color', 'white');
          flake.setAttribute('opacity', 0.6 + Math.random() * 0.3);
          flake.setAttribute('position', `${x} ${y} ${z}`);
          flake.dataset = {
            speed: 0.05 + Math.random() * 0.1,
            angleX: Math.random() * Math.PI * 2,
            angleZ: Math.random() * Math.PI * 2
          };
          system.appendChild(flake);
          snowflakes.push(flake);
        }
      }

      // –ï—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è —á–µ—Ä–µ–∑ requestAnimationFrame
      function animateSnow(timestamp) {
        if (!snowflakes.length) return;

        const time = timestamp * 0.001;
        for (let flake of snowflakes) {
          const pos = flake.getAttribute('position');
          const speed = flake.dataset.speed;
          const newY = pos.y - speed * 0.8;

          if (newY < -0.35) {
            // –ü–µ—Ä–µ–º—ñ—â—É—î–º–æ —Å–Ω—ñ–∂–∏–Ω–∫—É –≤–≥–æ—Ä—É
            flake.setAttribute('position', `${(Math.random() - 0.5) * 0.6} 0.35 ${(Math.random() - 0.5) * 0.6}`);
          } else {
            const swingX = Math.sin(time * 2 + flake.dataset.angleX) * 0.015;
            const swingZ = Math.cos(time * 1.5 + flake.dataset.angleZ) * 0.015;
            flake.setAttribute('position', `${pos.x + swingX} ${newY} ${pos.z + swingZ}`);
          }

          flake.setAttribute('rotation', `${time * 20} ${time * 30} ${time * 25}`);
          const flicker = 0.6 + Math.sin(time * 4 + flake.dataset.angleX) * 0.3;
          flake.setAttribute('opacity', flicker);
        }

        animationId = requestAnimationFrame(animateSnow);
      }

      // –û–±—Ä–æ–±–Ω–∏–∫ –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –∫—É–ª–µ—é
      function setupClickHandler(sphere) {
        const handleClick = () => {
          if (isRotating) return;
          isRotating = true;
          const text = document.getElementById('magic-text');
          if (!text) return;

          text.setAttribute('animation__rotate', {
            property: 'rotation',
            to: `0 ${parseInt(text.getAttribute('rotation').y || 0) + 360} 0`,
            dur: 800,
            easing: 'easeOutCubic'
          });

          setTimeout(() => {
            currentTextIndex = (currentTextIndex + 1) % texts.length;
            text.setAttribute('value', texts[currentTextIndex]);
            isRotating = false;
          }, 800);
        };

        sphere.addEventListener('click', handleClick);
        sphere.addEventListener('touchstart', (e) => {
          e.preventDefault();
          handleClick();
        });
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
      if (!navigator.mediaDevices?.getUserMedia) {
        showError('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∫–∞–º–µ—Ä—É. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Chrome/Safari.');
      }
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        showError('–ü–æ—Ç—Ä—ñ–±–µ–Ω HTTPS –¥–ª—è —Ä–æ–±–æ—Ç–∏ AR.');
      }

      // –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ü–µ–Ω–∏
      const scene = document.querySelector('a-scene');
      if (!scene) {
        showError('–°—Ü–µ–Ω–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
        return;
      }

      scene.addEventListener('loaded', () => {
        console.log('‚úÖ AR —Å—Ü–µ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');

        // ‚úÖ –•–æ–≤–∞—î–º–æ –µ–∫—Ä–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—è–¥–æ–∫, —è–∫—â–æ —Ö–æ—á–µ—Ç–µ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏)
        loading.style.display = 'none';

        setupMusicControl();
        createSnowflakes();
        animateSnow(0);

        const sphere = document.getElementById('magic-sphere');
        if (sphere) {
          setupClickHandler(sphere);
        } else {
          setTimeout(() => {
            const s = document.getElementById('magic-sphere');
            if (s) setupClickHandler(s);
          }, 1000);
        }
      });

      scene.addEventListener('error', (e) => {
        showError('–ü–æ–º–∏–ª–∫–∞ AR: ' + (e.detail?.message || JSON.stringify(e.detail)));
      });
    });
  </script>
</body>
</html>
