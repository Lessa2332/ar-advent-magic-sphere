<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Передай лист Санті</title>

    <!-- 1. A-Frame ПЕРШИМ у <head> — це усуває всі попередження -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
    <!-- 2. MindAR-AFrame (він сам підтягує правильну версію Three.js) -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body{margin:0;overflow:hidden;background:#0a1e3a;color:white;font-family:sans-serif}
        .hidden{display:none!important}
        #startScreen{position:fixed;inset:0;background:linear-gradient(135deg,#0f3443,#1e5a7e);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;z-index:100}
        h1{font-size:2.8em;color:#ffd700;text-shadow:0 0 20px gold;margin-bottom:20px}
        button{background:#e74c3c;color:white;border:none;padding:18px 50px;font-size:1.6em;border-radius:50px;margin-top:30px;box-shadow:0 10px 30px rgba(231,76,60,.6);cursor:pointer;transition:.2s}
        button:active{transform:scale(.95)}
        #arContainer{position:fixed;inset:0}
        #hint{position:absolute;top:15px;left:50%;transform:translateX(-50%);background:#000000cc;padding:12px 30px;border-radius:20px;font-size:1.7em;z-index:10;pointer-events:none;text-align:center;max-width:90%}
        #sendBtn{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);padding:20px 60px;font-size:2em;background:#27ae60;border-radius:50px;z-index:20;display:none}
        #elfIdle,#elfMagic{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:85vw;max-width:400px;height:auto;max-height:75vh;background-size:100% auto;background-repeat:no-repeat;background-position:center bottom;pointer-events:none;opacity:0;transition:opacity 1.3s ease;z-index:5}
        #elfMagic{z-index:6}
        #loading{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center;font-size:2em;z-index:999}
    </style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<div id="arContainer" class="hidden">
    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>
    <div id="elfIdle"></div>
    <div id="elfMagic"></div>
</div>

<div id="loading" class="hidden">Завантаження...</div>

<script>
document.getElementById('startBtn').onclick = async () => {
    if (location.protocol !== 'https:' && !location.hostname.includes('localhost')) {
        alert('Потрібен HTTPS!'); return;
    }

    // Перевірка файлів
    const files = ['targets.mind','elf-idle.png','elf-magic.png','waiting.mp3','magic-sound.mp3'];
    for (const f of files) {
        if (!await fetch(f,{method:'HEAD'}).then(r=>r.ok)) {
            alert('Не знайдено файл: '+f); location.reload(); return;
        }
    }

    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('arContainer').classList.remove('hidden');
    document.getElementById('loading').classList.remove('hidden');

    const sceneHTML = `
        <a-scene mindar-image="imageTargetSrc: targets.mind; uiLoading: no; uiScanning: no;" embedded renderer="colorManagement:false">
            <a-camera position="0 1.6 0"></a-camera>

            <!-- Дзвіночок (targetIndex 0) -->
            <a-entity mindar-image-target="targetIndex: 0"></a-entity>

            <!-- Зірочка (targetIndex 1) — тут ельф і звук -->
            <a-entity mindar-image-target="targetIndex: 1">
                <a-entity position="0 1 0" sound="src: waiting.mp3; autoplay: false; loop: true; positional: true; refDistance: 0.8; maxDistance: 10"></a-entity>
            </a-entity>
        </a-scene>
    `;
    document.getElementById('arContainer').innerHTML += sceneHTML;

    const sceneEl = document.querySelector('a-scene');
    const anchor1 = sceneEl.querySelectorAll('a-entity')[1];   // дзвіночок
    const anchor2 = sceneEl.querySelectorAll('a-entity')[2];   // зірочка
    const audioEntity = anchor2.querySelector('a-entity');

    let step = 0;
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdle = document.getElementById('elfIdle');
    const elfMagic = document.getElementById('elfMagic');
    const magicSound = new Audio('magic-sound.mp3'); magicSound.volume = 0.9;

    anchor1.addEventListener('targetFound', () => {
        if (step === 0) { step = 1; hint.textContent = "Чудово! Тепер зірочку!"; }
    });

    anchor2.addEventListener('targetFound', () => {
        if (step !== 1) return;
        audioEntity.components.sound.play();
        hint.textContent = "Я тут, чекаю твого листа…";
        step = 2;
    });

    // Відстеження відстані
    sceneEl.addEventListener('renderstart', () => {
        const cam = sceneEl.camera;
        const loop = () => {
            if (step === 2 && anchor2.object3D.visible) {
                const dist = cam.position.distanceTo(anchor2.object3D.getWorldPosition(new THREE.Vector3()));
                audioEntity.components.sound.setVolume(Math.max(0.1, 1 - dist/5));

                if (dist < 0.5 && elfIdle.style.opacity == '0') {
                    elfIdle.style.background = 'url("elf-idle.png") center bottom / 100% auto no-repeat';
                    elfIdle.style.opacity = 1;
                    sendBtn.style.display = 'block';
                }
            }
            requestAnimationFrame(loop);
        };
        loop();
    });

    // Idle анімація
    let frame = 0;
    setInterval(() => {
        if (elfIdle.style.opacity > 0) {
            frame = (frame + 1) % 30;
            elfIdle.style.backgroundPosition = `center ${-frame * (100/30)}%`;
        }
    }, 100);

    // Магія
    sendBtn.onclick = () => {
        sendBtn.style.display = 'none';
        elfIdle.style.opacity = 0;
        audioEntity.components.sound.stop();

        elfMagic.style.background = 'url("elf-magic.png") center bottom / 100% auto no-repeat';
        elfMagic.style.opacity = 1;
        magicSound.currentTime = 0;
        magicSound.play();

        hint.textContent = "Я передав твоє бажання Санті! Вітаю з Різдвом!";

        let f = 0;
        const anim = setInterval(() => {
            f++;
            if (f >= 36) {
                clearInterval(anim);
                setTimeout(() => {
                    elfMagic.style.opacity = 0;
                    hint.innerHTML = 'Я передав твоє бажання Санті!<br><br><button onclick="location.reload()" style="padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer">Розпочати знову</button>';
                }, 1000);
            } else {
                elfMagic.style.backgroundPosition = `center ${-f * (100/36)}%`;
            }
        }, 80);
    };

    document.getElementById('loading').classList.add('hidden');
};
</script>
</body>
</html>
