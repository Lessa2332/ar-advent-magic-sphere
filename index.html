<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–µ—Ä–µ–¥–∞–π –ª–∏—Å—Ç –°–∞–Ω—Ç—ñ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÑ</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #0a1e3a;
            color: white;
            font-family: sans-serif;
        }
        .hidden { display: none !important; }
       
        #startScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f3443, #1e5a7e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 100;
        }
        h1 {
            font-size: 2.8em;
            color: #ffd700;
            text-shadow: 0 0 20px gold;
            margin-bottom: 20px;
        }
       
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.6em;
            border-radius: 50px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(231,76,60,.6);
            cursor: pointer;
            transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
       
        #arContainer { position: fixed; inset: 0; }
       
        #hint {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: #000000cc;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 1.7em;
            z-index: 10;
            pointer-events: none;
            text-align: center;
            width: auto;
            max-width: 90%;
            padding-bottom: 20px;
        }
        #sendBtn {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 60px;
            font-size: 2em;
            background: #27ae60;
            border-radius: 50px;
            z-index: 20;
            display: none;
        }
       
        #elfIdle, #elfMagic {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 85vw;
            max-width: 400px;
            height: auto;
            max-height: 75vh;
            background-size: 100% auto;
            background-repeat: no-repeat;
            background-position: center bottom;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1.3s ease;
            z-index: 5;
        }
        #elfMagic { z-index: 6; }
       
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            z-index: 999;
        }
    </style>
</head>
<body>
<div id="startScreen">
    <h1>–ü–µ—Ä–µ–¥–∞–π –ª–∏—Å—Ç –°–∞–Ω—Ç—ñ</h1>
    <p>–ù–∞–ø–∏—à–∏ –±–∞–∂–∞–Ω–Ω—è –Ω–∞ –ø–∞–ø–µ—Ä—ñ ‚Äî —ñ –≤—ñ–¥–¥–∞–π –π–æ–≥–æ –µ–ª—å—Ñ—É!</p>
    <button id="startBtn">–ü–æ—á–∞—Ç–∏</button>
</div>
<div id="arContainer" class="hidden">
    <div id="hint">–ó–Ω–∞–π–¥–∏ –¥–∑–≤—ñ–Ω–æ—á–æ–∫!</div>
    <button id="sendBtn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç</button>
    <div id="elfIdle"></div>
    <div id="elfMagic"></div>
</div>
<div id="loading" class="loading hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

<script>
    let waitingSound, magicSound;
    let step = 0;
    let isSoundPlaying = false;
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdle = document.getElementById('elfIdle');
    const elfMagic = document.getElementById('elfMagic');
    const loading = document.getElementById('loading');
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤
    async function checkResource(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch {
            return false;
        }
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤—É–∫—É
    function playWaitingSound() {
        if (!waitingSound || isSoundPlaying) return;
        
        try {
            waitingSound.currentTime = 0;
            waitingSound.play();
            isSoundPlaying = true;
            console.log("–ó–≤—É–∫ –∑–∞–ø—É—â–µ–Ω–æ");
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤—É–∫—É:", error);
        }
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ –∑–≤—É–∫—É
    function stopWaitingSound() {
        if (waitingSound && isSoundPlaying) {
            waitingSound.pause();
            isSoundPlaying = false;
            console.log("–ó–≤—É–∫ –∑—É–ø–∏–Ω–µ–Ω–æ");
        }
    }
    
    document.getElementById('startBtn').addEventListener('click', async () => {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            alert('–¶–µ–π –¥–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞—Ü—é—î –ª–∏—à–µ —á–µ—Ä–µ–∑ HTTPS –∞–±–æ localhost.');
            return;
        }
        
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('arContainer').classList.remove('hidden');
        loading.classList.remove('hidden');
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤
        const requiredResources = [
            'targets.mind',
            'elf-idle.png',
            'elf-magic.png',
            'waiting.mp3',
            'magic-sound.mp3'
        ];
        
        for (const resource of requiredResources) {
            const exists = await checkResource(resource);
            if (!exists) {
                alert(`–ü–æ–º–∏–ª–∫–∞: –§–∞–π–ª ${resource} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤—Å—ñ —Ñ–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π.`);
                location.reload();
                return;
            }
        }
        
        try {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞—É–¥—ñ–æ
            waitingSound = new Audio('waiting.mp3');
            waitingSound.loop = true;
            waitingSound.volume = 0.7;
            
            magicSound = new Audio('magic-sound.mp3');
            magicSound.volume = 0.9;
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ A-Scene
            const sceneEl = document.createElement('a-scene');
            sceneEl.setAttribute('mindar-image', 'imageTargetSrc: targets.mind; uiLoading: no; uiScanning: no; maxTrack: 2;');
            sceneEl.setAttribute('vr-mode-ui', 'enabled: false');
            sceneEl.setAttribute('embedded', '');
            sceneEl.setAttribute('renderer', 'colorManagement: false; sortObjects: true');
            document.getElementById('arContainer').appendChild(sceneEl);

            // –î–æ–¥–∞—î–º–æ –∫–∞–º–µ—Ä—É
            const camera = document.createElement('a-camera');
            camera.setAttribute('position', '0 1.6 0');
            sceneEl.appendChild(camera);

            // –ü–µ—Ä—à–∏–π –º–∞—Ä–∫–µ—Ä ‚Äî –¥–∑–≤—ñ–Ω–æ—á–æ–∫
            const anchor1 = document.createElement('a-entity');
            anchor1.setAttribute('mindar-image-target', 'targetIndex: 0');
            sceneEl.appendChild(anchor1);

            // –î—Ä—É–≥–∏–π –º–∞—Ä–∫–µ—Ä ‚Äî –∑—ñ—Ä–æ—á–∫–∞
            const anchor2 = document.createElement('a-entity');
            anchor2.setAttribute('mindar-image-target', 'targetIndex: 1');
            sceneEl.appendChild(anchor2);

            anchor1.addEventListener('targetFound', () => {
                if (step === 0) {
                    step = 1;
                    hint.textContent = "–ß—É–¥–æ–≤–æ! –¢–µ–ø–µ—Ä –∑—ñ—Ä–æ—á–∫—É!";
                }
            });

            anchor2.addEventListener('targetFound', () => {
                if (step !== 1) return;
                
                console.log("–ú–∞—Ä–∫–µ—Ä 2 –∑–Ω–∞–π–¥–µ–Ω–æ");
                playWaitingSound();
                
                hint.textContent = "–Ø —Ç—É—Ç, —á–µ–∫–∞—é —Ç–≤–æ–≥–æ –ª–∏—Å—Ç–∞‚Ä¶";
                step = 2;
            });

            anchor2.addEventListener('targetLost', () => {
                console.log("–ú–∞—Ä–∫–µ—Ä 2 –≤—Ç—Ä–∞—á–µ–Ω–æ");
                // –ù–ï –∑—É–ø–∏–Ω—è—î–º–æ –∑–≤—É–∫ - –≤—ñ–Ω –≥—Ä–∞—î –ø–æ—Å—Ç—ñ–π–Ω–æ –ø–æ–∫–∏ –Ω–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞ –∫–Ω–æ–ø–∫–∞
            });

            // –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤—ñ–¥—Å—Ç–∞–Ω—ñ –¥–æ –µ–ª—å—Ñ–∞
            sceneEl.addEventListener('renderstart', () => {
                const camera = sceneEl.camera;
                let elfVisible = false;
                
                const update = () => {
                    if (step === 2 && anchor2.object3D.visible) {
                        const dist = camera.position.distanceTo(anchor2.object3D.getWorldPosition(new THREE.Vector3()));

                        // –û–Ω–æ–≤–ª—é—î–º–æ –≥—É—á–Ω—ñ—Å—Ç—å –∑–≤—É–∫—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—ñ–¥—Å—Ç–∞–Ω—ñ
                        if (waitingSound) {
                            const volume = Math.max(0.1, 1 - dist/5);
                            waitingSound.volume = volume * 0.7;
                        }

                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –¥–∏—Ç–∏–Ω–∞ –ø—ñ–¥—ñ–π—à–ª–∞ –±–ª–∏–∂—á–µ 50 —Å–º
                        if (dist < 0.5) {
                            if (!elfVisible) {
                                elfVisible = true;
                                elfIdle.classList.remove('hidden');
                                elfIdle.style.background = 'url("elf-idle.png") center bottom / 100% auto no-repeat';
                                setTimeout(() => elfIdle.style.opacity = '1', 100);
                                sendBtn.style.display = 'block';
                                console.log("–ï–ª—å—Ñ –∑'—è–≤–∏–≤—Å—è - –≤—ñ–¥—Å—Ç–∞–Ω—å:", dist.toFixed(2) + "–º");
                            }
                        } else {
                            if (elfVisible) {
                                elfVisible = false;
                                elfIdle.style.opacity = '0';
                                sendBtn.style.display = 'none';
                                console.log("–ï–ª—å—Ñ —Å—Ö–æ–≤–∞–≤—Å—è - –≤—ñ–¥—Å—Ç–∞–Ω—å:", dist.toFixed(2) + "–º");
                            }
                        }
                    }
                    requestAnimationFrame(update);
                };
                update();
            });

            // –ê–Ω—ñ–º–∞—Ü—ñ—è idle
            let frame = 0;
            const idleInterval = setInterval(() => {
                if (parseFloat(elfIdle.style.opacity) > 0) {
                    frame = (frame + 1) % 24;
                    elfIdle.style.backgroundPosition = `center ${-frame * (100 / 24)}%`;
                }
            }, 120);

            // –û–±—Ä–æ–±–Ω–∏–∫ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ª–∏—Å—Ç–∞
            sendBtn.onclick = () => {
                sendBtn.style.display = 'none';
                elfIdle.style.opacity = '0';
                
                // –ó—É–ø–∏–Ω—è—î–º–æ –∑–≤—É–∫ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
                stopWaitingSound();
                
                clearInterval(idleInterval);
                elfMagic.classList.remove('hidden');
                elfMagic.style.background = 'url("elf-magic.png") center bottom / 100% auto no-repeat';
               
                setTimeout(() => {
                    elfMagic.style.opacity = '1';
                    if (magicSound) {
                        magicSound.currentTime = 0;
                        magicSound.play();
                    }
                }, 100);
                
                hint.textContent = "–Ø –ø–µ—Ä–µ–¥–∞–≤ —Ç–≤–æ—î –±–∞–∂–∞–Ω–Ω—è –°–∞–Ω—Ç—ñ! –í—ñ—Ç–∞—é –∑ –†—ñ–∑–¥–≤–æ–º!";
                
                let f = 0;
                const anim = setInterval(() => {
                    f++;
                    if (f >= 36) {
                        clearInterval(anim);
                        setTimeout(() => {
                            elfMagic.style.opacity = '0';
                            hint.innerHTML = '–Ø –ø–µ—Ä–µ–¥–∞–≤ —Ç–≤–æ—î –±–∞–∂–∞–Ω–Ω—è –°–∞–Ω—Ç—ñ!<br><br>';
                           
                            const restartBtn = document.createElement('button');
                            restartBtn.textContent = '–†–æ–∑–ø–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É';
                            restartBtn.style.cssText = 'padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer';
                            restartBtn.onclick = () => location.reload();
                            hint.appendChild(restartBtn);
                        }, 1200);
                    } else {
                        elfMagic.style.backgroundPosition = `center ${-f * (100 / 36)}%`;
                    }
                }, 80);
            };

            loading.classList.add('hidden');
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É AR:', e);
            loading.classList.add('hidden');
            alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏. –£–≤—ñ–º–∫–Ω—ñ—Ç—å –¥–æ–∑–≤—ñ–ª.');
           
            document.getElementById('arContainer').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
    });
</script>
</body>
</html>
