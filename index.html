<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval' blob:; worker-src * blob: data:; connect-src *; img-src * data: blob:; style-src * 'unsafe-inline';">
    <title>Передай лист Санті</title>
    
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            background: #0a1e3a;
            font-family: sans-serif;
        }
        
        #startScreen, #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f3443, #1e5a7e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            z-index: 100;
        }
        
        h1 {
            font-size: 2.8em;
            color: #ffd700;
            text-shadow: 0 0 20px gold;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        
        p {
            font-size: 1.4em;
            margin-bottom: 30px;
            padding: 0 20px;
            max-width: 600px;
        }
        
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.6em;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(231,76,60,.6);
            cursor: pointer;
            transition: .2s;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        #hint {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #000000cc;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 1.5em;
            z-index: 1000;
            pointer-events: none;
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        #sendBtn {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #27ae60;
            padding: 20px 60px;
            font-size: 1.8em;
            border-radius: 50px;
            z-index: 1000;
            display: none;
            cursor: pointer;
            border: none;
            color: white;
            box-shadow: 0 10px 30px rgba(39,174,96,.6);
        }
        
        .hidden {
            display: none !important;
        }
        
        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1;
        }
    </style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<div id="loading" class="hidden">Завантаження...</div>

<a-scene id="scene" class="hidden" embedded
         mindar-image="imageTargetSrc: targets.mind; uiLoading:no; uiScanning:no; maxTrack:2"
         vr-mode-ui="enabled:false" renderer="colorManagement:false">

    <a-assets timeout="15000">
        <audio id="waiting" src="waiting.mp3"></audio>
        <audio id="magic" src="magic-sound.mp3"></audio>
        <img id="elfIdle" src="elf-idle.png">
        <img id="elfMagic" src="elf-magic.png">
    </a-assets>

    <a-camera position="0 1.6 0" wasd-controls="enabled: false"></a-camera>

    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>

    <a-entity mindar-image-target="targetIndex: 0" bell-listener></a-entity>

    <a-entity id="starAnchor" mindar-image-target="targetIndex: 1">
        <a-entity id="elfContainer" position="1.4 1.1 -0.8">

            <a-entity id="elfIdle" visible="false">
                <a-plane src="#elfIdle" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 24"
                         animation="property: material.offsetRepeat.y; from:0; to:-23; dur:2880; loop:true; easing:linear">
                </a-plane>
                <a-sound src="#waiting" autoplay="false" loop="true" positional="true"
                         ref-distance="0.4" max-distance="6" rolloff-factor="2" volume="1"></a-sound>
            </a-entity>

            <a-entity id="elfMagic" visible="false">
                <a-plane src="#elfMagic" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 36"
                         animation="property: material.offsetRepeat.y; from:0; to:-35; dur:2880; easing:linear; startEvents:playMagic">
                </a-plane>
                <a-sound src="#magic" autoplay="false" positional="true"
                         ref-distance="0.3" max-distance="5" volume="1"></a-sound>
            </a-entity>

        </a-entity>
    </a-entity>
</a-scene>

<script>
    let step = 0;
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdle = document.querySelector('#elfIdle');
    const elfMagic = document.querySelector('#elfMagic');
    const elfContainer = document.querySelector('#elfContainer');
    const waitingSound = elfIdle.querySelector('a-sound');
    const magicSound = elfMagic.querySelector('a-sound');
    const magicPlane = elfMagic.querySelector('a-plane');

    AFRAME.registerComponent('bell-listener', {
        init: function(){
            this.el.addEventListener('targetFound', () => {
                if (step === 0) {
                    step = 1;
                    hint.textContent = "Чудово! Тепер зірочку!";
                }
            });
        }
    });

    document.getElementById('startBtn').onclick = () => {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        
        setTimeout(() => {
            document.getElementById('scene').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }, 800);
    };

    document.querySelector('#starAnchor').addEventListener('targetFound', () => {
        if (step !== 1) return;
        step = 2;
        hint.textContent = "Я десь поруч… підійди ближче, почуєш!";
        
        setTimeout(() => {
            try {
                waitingSound.components.sound.playSound();
            } catch (error) {
                console.log("Звук може не працювати на деяких пристроях");
            }
        }, 300);
    });

    document.querySelector('#starAnchor').addEventListener('targetLost', () => {
        sendBtn.style.display = 'none';
        elfIdle.setAttribute('visible', false);
    });

    document.querySelector('a-scene').addEventListener('renderstart', () => {
        const camera = document.querySelector('a-camera').object3D;
        const update = () => {
            if (step === 2 && elfContainer.object3D.visible) {
                const pos = new THREE.Vector3();
                elfContainer.object3D.getWorldPosition(pos);
                const dist = camera.position.distanceTo(pos);

                if (waitingSound.components.sound && waitingSound.components.sound.isPlaying) {
                    const vol = Math.max(0.1, Math.min(1, 1 - dist/4));
                    waitingSound.setAttribute('sound', 'volume', vol);
                }

                const near = dist < 0.5;
                elfIdle.setAttribute('visible', near);
                sendBtn.style.display = near ? 'block' : 'none';
            }
            requestAnimationFrame(update);
        };
        update();
    });

    sendBtn.onclick = () => {
        sendBtn.style.display = 'none';
        elfIdle.setAttribute('visible', false);
        
        if (waitingSound.components.sound) {
            waitingSound.components.sound.stopSound();
        }

        elfMagic.setAttribute('visible', true);
        
        if (magicSound.components.sound) {
            magicSound.components.sound.playSound();
        }
        
        magicPlane.emit('playMagic');

        hint.innerHTML = "Я передав твоє бажання Санті!<br>Вітаю з Різдвом!";

        setTimeout(() => {
            elfMagic.setAttribute('visible', false);
            const btn = document.createElement('button');
            btn.textContent = 'Заново';
            btn.style.cssText = 'margin-top:20px;padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer';
            btn.onclick = () => location.reload();
            hint.appendChild(btn);
        }, 4000);
    };
</script>
</body>
</html>
