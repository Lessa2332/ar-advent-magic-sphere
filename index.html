<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Передай лист Санті</title>
    
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #0a1e3a;
            color: white;
            font-family: sans-serif;
        }
        .hidden { display: none !important; }
       
        #startScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f3443, #1e5a7e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 100;
        }
        h1 {
            font-size: 2.8em;
            color: #ffd700;
            text-shadow: 0 0 20px gold;
            margin-bottom: 20px;
        }
       
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.6em;
            border-radius: 50px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(231,76,60,.6);
            cursor: pointer;
            transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
       
        #arContainer { 
            position: fixed; 
            inset: 0; 
        }
       
        #hint {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: #000000cc;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 1.7em;
            z-index: 10;
            pointer-events: none;
            text-align: center;
            width: auto;
            max-width: 90%;
        }
        
        #sendBtn {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 60px;
            font-size: 2em;
            background: #27ae60;
            border-radius: 50px;
            z-index: 20;
            display: none;
            border: none;
            color: white;
            cursor: pointer;
        }
       
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            z-index: 999;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
        }

        /* Стилі для UI ельфів */
        .elf-ui {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 85vw;
            max-width: 400px;
            height: 75vh;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 1.3s ease;
        }
        
        .elf-sprite {
            width: 100%;
            height: 100%;
            background-size: 100% auto;
            background-repeat: no-repeat;
            background-position: center bottom;
        }
        
        #elfIdleUI { z-index: 5; }
        #elfMagicUI { z-index: 6; }
    </style>
</head>
<body>
<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<div id="arContainer" class="hidden">
    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>
    
    <!-- UI ельфи для анімацій -->
    <div id="elfIdleUI" class="elf-ui hidden">
        <div class="elf-sprite"></div>
    </div>
    <div id="elfMagicUI" class="elf-ui hidden">
        <div class="elf-sprite"></div>
    </div>
</div>

<div id="loading" class="loading hidden">Завантаження...</div>

<script>
    // Реєстрація кастомного компонента для спрайт-анімації
    AFRAME.registerComponent('sprite-animation', {
        schema: {
            rows: {type: 'int', default: 1},
            columns: {type: 'int', default: 1},
            frameCount: {type: 'int', default: 1},
            frameRate: {type: 'number', default: 24},
            loop: {type: 'boolean', default: true}
        },
        
        init: function () {
            this.currentFrame = 0;
            this.frameTime = 1000 / this.data.frameRate;
            this.lastUpdate = 0;
            this.material = this.el.getObject3D('mesh').material;
            this.frameWidth = 1 / this.data.columns;
            this.frameHeight = 1 / this.data.rows;
        },
        
        tick: function (time, timeDelta) {
            if (!this.material || !this.material.map) return;
            
            if (time - this.lastUpdate > this.frameTime) {
                this.currentFrame++;
                if (this.currentFrame >= this.data.frameCount) {
                    if (this.data.loop) {
                        this.currentFrame = 0;
                    } else {
                        this.currentFrame = this.data.frameCount - 1;
                        return;
                    }
                }
                
                const col = this.currentFrame % this.data.columns;
                const row = Math.floor(this.currentFrame / this.data.columns);
                
                const offsetX = col * this.frameWidth;
                const offsetY = 1 - (row + 1) * this.frameHeight;
                
                this.material.map.offset.set(offsetX, offsetY);
                this.material.map.repeat.set(this.frameWidth, this.frameHeight);
                
                this.lastUpdate = time;
            }
        }
    });

    let step = 0;
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const loading = document.getElementById('loading');
    const elfIdleUI = document.getElementById('elfIdleUI');
    const elfMagicUI = document.getElementById('elfMagicUI');

    document.getElementById('startBtn').addEventListener('click', async () => {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            alert('Цей додаток працює лише через HTTPS або localhost.');
            return;
        }
        
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('arContainer').classList.remove('hidden');
        loading.classList.remove('hidden');
        
        try {
            // Створюємо A-Scene
            const sceneEl = document.createElement('a-scene');
            sceneEl.setAttribute('mindar-image', 'imageTargetSrc: targets.mind; uiLoading: no; uiScanning: no; maxTrack: 2;');
            sceneEl.setAttribute('vr-mode-ui', 'enabled: false');
            sceneEl.setAttribute('embedded', '');
            sceneEl.setAttribute('renderer', 'colorManagement: false');
            document.getElementById('arContainer').appendChild(sceneEl);

            // Додаємо ресурси
            const assets = document.createElement('a-assets');
            assets.setAttribute('timeout', '30000');
            
            // Аудіо
            const waitingAudio = document.createElement('audio');
            waitingAudio.setAttribute('id', 'waiting-sound');
            waitingAudio.setAttribute('src', 'waiting.mp3');
            waitingAudio.setAttribute('preload', 'auto');
            assets.appendChild(waitingAudio);
            
            const magicAudio = document.createElement('audio');
            magicAudio.setAttribute('id', 'magic-sound');
            magicAudio.setAttribute('src', 'magic-sound.mp3');
            magicAudio.setAttribute('preload', 'auto');
            assets.appendChild(magicAudio);
            
            // Текстури для 3D ельфів
            const elfIdleImg = document.createElement('img');
            elfIdleImg.setAttribute('id', 'elf-idle-img');
            elfIdleImg.setAttribute('src', 'elf-idle.png');
            assets.appendChild(elfIdleImg);
            
            const elfMagicImg = document.createElement('img');
            elfMagicImg.setAttribute('id', 'elf-magic-img');
            elfMagicImg.setAttribute('src', 'elf-magic.png');
            assets.appendChild(elfMagicImg);
            
            sceneEl.appendChild(assets);

            // Камера
            const camera = document.createElement('a-camera');
            camera.setAttribute('position', '0 1.6 0');
            camera.setAttribute('wasd-controls', 'enabled: false');
            sceneEl.appendChild(camera);

            // Маркери
            const anchor1 = document.createElement('a-entity');
            anchor1.setAttribute('mindar-image-target', 'targetIndex: 0');
            sceneEl.appendChild(anchor1);

            const anchor2 = document.createElement('a-entity');
            anchor2.setAttribute('mindar-image-target', 'targetIndex: 1');
            sceneEl.appendChild(anchor2);

            // 3D ельф на другому маркері
            const elfContainer = document.createElement('a-entity');
            elfContainer.setAttribute('position', '1.4 1.1 -0.8');
            elfContainer.setAttribute('visible', 'false');
            
            // Простий 3D ельф (куб замість спрайта)
            const elfGeometry = document.createElement('a-box');
            elfGeometry.setAttribute('color', '#00FF00');
            elfGeometry.setAttribute('width', '0.3');
            elfGeometry.setAttribute('height', '0.6');
            elfGeometry.setAttribute('depth', '0.3');
            elfGeometry.setAttribute('position', '0 0.3 0');
            elfContainer.appendChild(elfGeometry);
            
            // Голова ельфа
            const elfHead = document.createElement('a-sphere');
            elfHead.setAttribute('color', '#FFCC99');
            elfHead.setAttribute('radius', '0.15');
            elfHead.setAttribute('position', '0 0.6 0');
            elfContainer.appendChild(elfHead);
            
            // Капелюх
            const elfHat = document.createElement('a-cone');
            elfHat.setAttribute('color', '#FF0000');
            elfHat.setAttribute('radius-bottom', '0.2');
            elfHat.setAttribute('radius-top', '0.05');
            elfHat.setAttribute('height', '0.3');
            elfHat.setAttribute('position', '0 0.8 0');
            elfContainer.appendChild(elfHat);

            // Звук очікування
            const waitingSound3d = document.createElement('a-sound');
            waitingSound3d.setAttribute('src', '#waiting-sound');
            waitingSound3d.setAttribute('autoplay', 'false');
            waitingSound3d.setAttribute('loop', 'true');
            waitingSound3d.setAttribute('positional', 'true');
            waitingSound3d.setAttribute('ref-distance', '0.4');
            waitingSound3d.setAttribute('max-distance', '6');
            waitingSound3d.setAttribute('rolloff-factor', '2');
            waitingSound3d.setAttribute('volume', '1');
            elfContainer.appendChild(waitingSound3d);
            
            anchor2.appendChild(elfContainer);

            // Обробники подій
            anchor1.addEventListener('targetFound', () => {
                if (step === 0) {
                    step = 1;
                    hint.textContent = "Чудово! Тепер зірочку!";
                }
            });

            anchor2.addEventListener('targetFound', () => {
                if (step === 1) {
                    step = 2;
                    hint.textContent = "Я десь поруч… підійди ближче, почуєш!";
                    elfContainer.setAttribute('visible', 'true');
                    
                    setTimeout(() => {
                        const soundComp = waitingSound3d.components.sound;
                        if (soundComp && !soundComp.isPlaying) {
                            soundComp.playSound();
                        }
                    }, 300);
                }
            });

            anchor2.addEventListener('targetLost', () => {
                sendBtn.style.display = 'none';
                elfContainer.setAttribute('visible', 'false');
                elfIdleUI.classList.add('hidden');
                
                const soundComp = waitingSound3d.components.sound;
                if (soundComp && soundComp.isPlaying) {
                    soundComp.stopSound();
                }
            });

            // Відстеження відстані
            sceneEl.addEventListener('renderstart', () => {
                const cameraObj = document.querySelector('a-camera').object3D;
                
                const update = () => {
                    if (step === 2 && elfContainer.object3D.visible) {
                        const elfPos = new THREE.Vector3();
                        elfContainer.object3D.getWorldPosition(elfPos);
                        
                        const dist = cameraObj.position.distanceTo(elfPos);

                        // Гучність звуку
                        const soundComp = waitingSound3d.components.sound;
                        if (soundComp && soundComp.isPlaying) {
                            const volume = Math.max(0.1, Math.min(1, 1 - dist/4));
                            waitingSound3d.setAttribute('sound', 'volume', volume);
                        }

                        // Показ UI ельфа при близькій відстані
                        const isNear = dist < 0.5;
                        if (isNear) {
                            if (elfIdleUI.classList.contains('hidden')) {
                                elfIdleUI.classList.remove('hidden');
                                elfIdleUI.querySelector('.elf-sprite').style.backgroundImage = 'url("elf-idle.png")';
                                setTimeout(() => elfIdleUI.style.opacity = '1', 100);
                            }
                            sendBtn.style.display = 'block';
                            hint.textContent = "Натисни кнопку, щоб передати лист!";
                        } else {
                            elfIdleUI.style.opacity = '0';
                            setTimeout(() => elfIdleUI.classList.add('hidden'), 1300);
                            sendBtn.style.display = 'none';
                            hint.textContent = "Підійди ближче до ельфа!";
                        }
                    }
                    requestAnimationFrame(update);
                };
                update();
            });

            // Анімація idle ельфа
            let idleFrame = 0;
            const idleInterval = setInterval(() => {
                if (parseFloat(elfIdleUI.style.opacity) > 0) {
                    idleFrame = (idleFrame + 1) % 24;
                    elfIdleUI.querySelector('.elf-sprite').style.backgroundPosition = `center ${-idleFrame * (100 / 24)}%`;
                }
            }, 120);

            // Обробник відправки
            sendBtn.addEventListener('click', () => {
                step = 3;
                sendBtn.style.display = 'none';
                elfIdleUI.style.opacity = '0';
                
                // Зупиняємо звук та анімацію
                const waitingSoundComp = waitingSound3d.components.sound;
                if (waitingSoundComp && waitingSoundComp.isPlaying) {
                    waitingSoundComp.stopSound();
                }
                clearInterval(idleInterval);
                
                // Магічна анімація
                elfMagicUI.classList.remove('hidden');
                elfMagicUI.querySelector('.elf-sprite').style.backgroundImage = 'url("elf-magic.png")';
                
                setTimeout(() => {
                    elfMagicUI.style.opacity = '1';
                    
                    // Відтворюємо звук магії
                    const magicAudio = new Audio('magic-sound.mp3');
                    magicAudio.volume = 0.9;
                    magicAudio.play();
                }, 100);
                
                hint.textContent = "Я передав твоє бажання Санті! Вітаю з Різдвом!";
                
                // Анімація магії
                let magicFrame = 0;
                const magicInterval = setInterval(() => {
                    magicFrame++;
                    if (magicFrame >= 36) {
                        clearInterval(magicInterval);
                        setTimeout(() => {
                            elfMagicUI.style.opacity = '0';
                            setTimeout(() => {
                                elfMagicUI.classList.add('hidden');
                                hint.innerHTML = 'Я передав твоє бажання Санті!<br><br>';
                               
                                const restartBtn = document.createElement('button');
                                restartBtn.textContent = 'Заново';
                                restartBtn.style.cssText = 'margin-top:20px;padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer';
                                restartBtn.addEventListener('click', () => location.reload());
                                hint.appendChild(restartBtn);
                            }, 1200);
                        }, 500);
                    } else {
                        elfMagicUI.querySelector('.elf-sprite').style.backgroundPosition = `center ${-magicFrame * (100 / 36)}%`;
                    }
                }, 80);
            });

            loading.classList.add('hidden');

        } catch (e) {
            console.error('Помилка запуску AR:', e);
            loading.classList.add('hidden');
            alert('Не вдалося отримати доступ до камери. Увімкніть дозвіл.');
           
            document.getElementById('arContainer').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
    });
</script>
</body>
</html>
