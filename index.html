<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Передай лист Санті</title>
<style>
    body{margin:0;overflow:hidden;background:#0a1e3a;color:white;font-family:Arial,sans-serif}
    #startScreen{position:fixed;inset:0;background:linear-gradient(135deg,#0f3443,#1e5a7e);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;z-index:100}
    h1{font-size:2.8em;color:#ffd700;text-shadow:0 0 20px gold;margin-bottom:20px}
    button{background:#e74c3c;color:white;border:none;padding:18px 50px;font-size:1.6em;border-radius:50px;margin-top:30px;box-shadow:0 10px 30px rgba(231,76,60,.6);cursor:pointer}
    #arView{width:100%;height:100%;display:block}
    #ui{position:absolute;top:0;left:0;width:100%;padding:15px;pointer-events:none;z-index:10}
    #hint{background:#000000bb;padding:20px;border-radius:20px;text-align:center;font-size:1.8em}
    #sendBtn{position:absolute;bottom:100px;left:50%;transform:translateX(-50%);padding:20px 60px;font-size:2em;background:#27ae60;pointer-events:all;border-radius:50px;display:none;z-index:20}
    #elfIdle,#elfMagic{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:90%;max-width:420px;height:70vh;background-size:auto 100%;background-repeat:no-repeat;pointer-events:none;opacity:0;transition:opacity 1.5s;z-index:5}
    #elfMagic{z-index:6}
    .hidden{display:none!important}
</style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<canvas id="arView" class="hidden"></canvas>

<div id="ui" class="hidden">
    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>
    <div id="elfIdle"></div>
    <div id="elfMagic"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-three.prod.js"></script>

<script>
let step = 0, mindar, posAudio, elfPos = null;
const magicSound = new Audio('magic-sound.mp3');
magicSound.volume = 0.9;

const hint = document.getElementById('hint');
const sendBtn = document.getElementById('sendBtn');
const elfIdle = document.getElementById('elfIdle');
const elfMagic = document.getElementById('elfMagic');

document.getElementById('startBtn').onclick = async () => {
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('arView').classList.remove('hidden');
    document.getElementById('ui').classList.remove('hidden');
    hint.textContent = "Знайди дзвіночок!";

    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    await ctx.resume();

    mindar = new window.MINDAR.IMAGE.MindARThree({
        container: document.getElementById('ui'),
        imageTargetSrc: './targets.mind',
        uiLoading:'no', uiScanning:'no'
    });
    const {renderer, scene, camera} = mindar;
    const listener = new THREE.AudioListener(); camera.add(listener);

    posAudio = new THREE.PositionalAudio(listener);
    posAudio.setRefDistance(0.8);
    posAudio.setMaxDistance(10);
    posAudio.setRolloffFactor(2);
    posAudio.setLoop(true);
    const buf = await new THREE.AudioLoader().loadAsync('waiting.mp3');
    posAudio.setBuffer(buf);

    const a1 = mindar.addAnchor(0);
    const a2 = mindar.addAnchor(1);
    let pos1 = null;

    a1.onTargetFound = () => { if(step===0){ pos1 = new THREE.Vector3().setFromMatrixPosition(a1.group.matrixWorld); step=1; hint.textContent="Чудово! Тепер зірочку!"; } };
    a2.onTargetFound = () => {
        if(step!==1) return;
        const pos2 = new THREE.Vector3().setFromMatrixPosition(a2.group.matrixWorld);
        const dir = pos2.clone().sub(pos1).normalize();
        elfPos = pos2.clone().add(dir.multiplyScalar(3));

        const g = new THREE.Group(); g.position.copy(elfPos); g.add(posAudio); scene.add(g);
        posAudio.setVolume(0.3); posAudio.play();
        hint.textContent = "Я тут, чекаю твого листа…";
        step = 2;
    };

    // idle анімація
    let idleF = 0;
    setInterval(()=>{ if(elfIdle.style.opacity>0){ idleF=(idleF+1)%24; elfIdle.style.backgroundPosition=`0 ${-idleF*(100/24)}%`; } },120);

    renderer.setAnimationLoop(()=>{
        if(step===2 && elfPos){
            const cam = new THREE.Vector3(); camera.getWorldPosition(cam);
            const dist = cam.distanceTo(elfPos);
            posAudio.setVolume(THREE.MathUtils.clamp(1-dist/5,0.1,1));

            if(dist<0.5 && elfIdle.classList.contains('hidden')){
                elfIdle.classList.remove('hidden');
                elfIdle.style.background='url("elf-idle.png") 0 0/auto 100% no-repeat';
                setTimeout(()=>{ elfIdle.style.opacity=1; },100);
                sendBtn.style.display='block';
            }
        }
        renderer.render(scene,camera);
    });

    // КНОПКА — ВІДПРАВИТИ ЛИСТ
    sendBtn.onclick = () => {
        sendBtn.style.display='none';
        elfIdle.style.opacity=0;

        elfMagic.classList.remove('hidden');
        elfMagic.style.background='url("elf-magic.png") 0 0/auto 100% no-repeat';
        setTimeout(()=>{ elfMagic.style.opacity=1; magicSound.currentTime=0; magicSound.play(); },100);

        hint.textContent = "Я передав твоє бажання Санті! Вітаю з Різдвом!";

        let f=0;
        const anim = setInterval(()=>{
            f++;
            if(f>=30){
                clearInterval(anim);
                setTimeout(()=>{
                    elfMagic.style.opacity=0;
                    hint.innerHTML = "Я передав твоє бажання Санті! Вітаю з Різдвом!<br><br><button onclick=\"location.reload()\" style=\"padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px\">Розпочати знову</button>";
                },1000);
            } else {
                elfMagic.style.backgroundPosition = `0 ${-f*(100/30)}%`;
            }
        },80);
    };

    await mindar.start();
};
</script>
</body>
</html>
