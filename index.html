<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Передай лист Санті</title>
    <style>
        /* СТИЛІ */
        body { margin:0; overflow:hidden; background:#0a1e3a; color:white; font-family:sans-serif; }
        .hidden { display: none !important; }
        
        #startScreen { position:fixed; inset:0; background:linear-gradient(135deg,#0f3443,#1e5a7e); display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; z-index:100; }
        h1 { font-size:2.8em; color:#ffd700; text-shadow:0 0 20px gold; margin-bottom:20px; }
        
        /* КНОПКИ */
        button { background:#e74c3c; color:white; border:none; padding:18px 50px; font-size:1.6em; border-radius:50px; margin-top:30px; box-shadow:0 10px 30px rgba(231,76,60,.6); cursor:pointer; transition:0.2s; }
        button:active { transform:scale(0.95); }
        
        #arContainer { position:fixed; inset:0; }
        
        /* HINT (Підказка) */
        #hint { 
            position:absolute; top:15px; left:50%; transform:translateX(-50%); 
            background:#000000cc; padding:12px 30px; border-radius:20px; 
            font-size:1.7em; z-index:10; pointer-events:none; text-align:center;
            /* Додано для кращого відображення кнопки "Розпочати знову" */
            width: auto; max-width: 90%; padding-bottom: 20px;
        } 

        #sendBtn { position:absolute; bottom:90px; left:50%; transform:translateX(-50%); padding:20px 60px; font-size:2em; background:#27ae60; border-radius:50px; z-index:20; display:none; }
        
        /* СПРАЙТИ ЕЛЬФА */
        #elfIdle, #elfMagic {
            position:absolute; bottom:0; left:50%; transform:translateX(-50%);
            width:85vw; max-width:400px; height:auto; max-height:75vh;
            background-size:100% auto; background-repeat:no-repeat; background-position:center bottom;
            pointer-events:none; opacity:0; transition:opacity 1.3s ease; z-index:5;
        }
        #elfMagic { z-index:6; }
    </style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<div id="arContainer" class="hidden">
    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>
    <div id="elfIdle"></div>
    <div id="elfMagic"></div>
</div>

<script type="module">
    // ✅ ВИПРАВЛЕННЯ: Повернуто повні CDN-шляхи для коректного імпорту модулів
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
    import {MindARThree} from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-three.prod.js';

    let mindarThree, anchor2, posAudio, magicSound;
    let step = 0;

    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdle = document.getElementById('elfIdle');
    const elfMagic = document.getElementById('elfMagic');

    document.getElementById('startBtn').addEventListener('click', async () => {
        // Перевірка на HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            alert('Цей додаток працює лише через HTTPS або localhost.');
            return;
        }

        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('arContainer').classList.remove('hidden');

        // Ініціалізація аудіо
        magicSound = new Audio('magic-sound.mp3');
        magicSound.volume = 0.9;

        mindarThree = new MindARThree({
            container: document.getElementById('arContainer'),
            imageTargetSrc: 'targets.mind',
            uiLoading: 'no',
            uiScanning: 'no'
        });

        const { renderer, scene, camera } = mindarThree;

        // Налаштування Positional Audio
        const listener = new THREE.AudioListener();
        camera.add(listener);

        posAudio = new THREE.PositionalAudio(listener);
        posAudio.setRefDistance(0.8);
        posAudio.setMaxDistance(10);
        posAudio.setLoop(true);

        try {
            const buffer = await new THREE.AudioLoader().loadAsync('waiting.mp3');
            posAudio.setBuffer(buffer);
        } catch (e) {
            console.warn('Не вдалося завантажити waiting.mp3:', e);
        }

        const anchor1 = mindarThree.addAnchor(0); // дзвіночок
        anchor2 = mindarThree.addAnchor(1);      // зірочка

        anchor1.onTargetFound = () => {
            if (step === 0) {
                step = 1;
                hint.textContent = "Чудово! Тепер зірочку!";
            }
        };

        anchor2.onTargetFound = () => {
            if (step !== 1) return;

            // Група для підйому аудіо та віртуального положення ельфа на 1 метр над якорем
            const audioHolder = new THREE.Group();
            audioHolder.position.set(0, 1, 0); // 1 метр
            anchor2.group.add(audioHolder);
            audioHolder.add(posAudio);

            posAudio.setVolume(0.3);
            posAudio.play();
            hint.textContent = "Я тут, чекаю твого листа…";
            step = 2;
        };

        // Анімація idle
        let frame = 0;
        setInterval(() => {
            // Використовуємо parseFloat для надійної перевірки opacity
            if (parseFloat(elfIdle.style.opacity) > 0) {
                frame = (frame + 1) % 24;
                elfIdle.style.backgroundPosition = `center ${-frame * (100 / 24)}%`;
            }
        }, 120);

        renderer.setAnimationLoop(() => {
            if (step === 2 && anchor2?.group) {
                const camPos = new THREE.Vector3();
                camera.getWorldPosition(camPos);

                const elfPos = anchor2.group.getWorldPosition(new THREE.Vector3());
                elfPos.y += 1; // Враховуємо підйом на 1 метр

                const dist = camPos.distanceTo(elfPos);
                // Налаштування гучності
                posAudio.setVolume(THREE.MathUtils.clamp(1 - dist / 5, 0.1, 1));

                // Активація кнопки, коли користувач підходить близько (0.5м)
                if (dist < 0.5 && elfIdle.style.opacity === '0') {
                    elfIdle.classList.remove('hidden');
                    elfIdle.style.background = 'url("elf-idle.png") center bottom / 100% auto no-repeat';
                    setTimeout(() => elfIdle.style.opacity = '1', 100);
                    sendBtn.style.display = 'block';
                }
            }
            renderer.render(scene, camera);
        });

        // Обробник відправки листа (Магія!)
        sendBtn.onclick = () => {
            sendBtn.style.display = 'none';
            elfIdle.style.opacity = '0';
            posAudio.pause(); // Зупиняємо фоновий звук

            elfMagic.classList.remove('hidden');
            elfMagic.style.background = 'url("elf-magic.png") center bottom / 100% auto no-repeat';
            
            setTimeout(() => {
                elfMagic.style.opacity = '1';
                magicSound.currentTime = 0;
                magicSound.play();
            }, 100);

            hint.textContent = "Я передав твоє бажання Санті! Вітаю з Різдвом!";

            let f = 0;
            const anim = setInterval(() => {
                f++;
                if (f >= 36) { // 36 кадрів
                    clearInterval(anim);
                    setTimeout(() => {
                        elfMagic.style.opacity = '0';
                        hint.innerHTML = 'Я передав твоє бажання Санті!<br><br>';
                        
                        // ✅ Безпечне створення кнопки перезапуску
                        const restartBtn = document.createElement('button');
                        restartBtn.textContent = 'Розпочати знову';
                        restartBtn.style.cssText = 'padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer';
                        restartBtn.onclick = () => location.reload();
                        hint.appendChild(restartBtn);

                    }, 1200);
                } else {
                    elfMagic.style.backgroundPosition = `center ${-f * (100 / 36)}%`;
                }
            }, 80);
        };

        try {
            await mindarThree.start();
        } catch (e) {
            console.error('Помилка запуску AR:', e);
            alert('Не вдалося отримати доступ до камери. Увімкніть дозвіл.');
            // Повернути стартовий екран у разі невдачі
            document.getElementById('arContainer').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden'); 
        }
    });
</script>
</body>
</html>
