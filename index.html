<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic AR Orb ðŸŽ„</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
        #info { 
            position: absolute; top: 10px; left: 10px; color: #fff; z-index: 100; 
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; font-size: 18px; 
            text-align: center; max-width: 300px; font-family: 'Caveat', cursive;
        }
        #today { color: #ffd700; font-weight: bold; }
        #lang-toggle { 
            background: rgba(255,255,255,0.2); border: 1px solid #ffd700; color: #ffd700; 
            padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-top: 5px; 
            font-size: 14px; 
        }
        #lang-toggle:hover { background: rgba(255,215,0,0.2); }
    </style>
</head>
<body>
    <div id="info">
        <div id="title">Magic AR Orb ðŸŽ„</div>
        <div id="today-line">Today: Day <span id="today">1</span></div>
        <div id="instruction">Point camera at marker and tap the orb!</div>
        <button id="lang-toggle">ðŸ‡ºðŸ‡¦ UA / EN</button>
    </div>
    <!-- Three.js r150 â€” ÑÑƒÐ¼Ñ–ÑÐ½Ð° Ð· MindAR v1.2.5 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
    <!-- MindAR â€” UMD-Ð²ÐµÑ€ÑÑ–Ñ— -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.umd.js"></script>
    <script>
        // Translations (EN primary, UA secondary)
        const translations = {
            en: {
                title: 'Magic AR Orb ðŸŽ„',
                todayLine: 'Today: Day',
                todayWait: '0 (wait for December!)',
                instruction: 'Point camera at marker and tap the orb!',
                dayLocked: 'Day {day} hasn\'t come yet! ðŸ”’',
                dayOpened: 'Day {day} already opened! ðŸŽ„',
                orbRotating: 'Orb is spinning... Select a day!',
                dayUnlocked: 'Day {day} unlocked! "{task}" ðŸŽ‰',
                error: 'Error: Check marker and HTTPS. Details in console.'
            },
            uk: {
                title: 'ÐœÐ°Ð³Ñ–Ñ‡Ð½Ð° AR ÐºÑƒÐ»Ñ ðŸŽ„',
                todayLine: 'Ð¡ÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–: Ð”ÐµÐ½ÑŒ',
                todayWait: '0 (Ñ‡ÐµÐºÐ°Ð¹ Ð³Ñ€ÑƒÐ´Ð½Ñ!)',
                instruction: 'ÐÐ°Ð²ÐµÐ´Ð¸ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ€ Ñ– Ñ‚Ð¾Ñ€ÐºÐ½Ð¸ÑÑ ÐºÑƒÐ»Ñ–!',
                dayLocked: 'Ð”ÐµÐ½ÑŒ {day} Ñ‰Ðµ Ð½Ðµ Ð½Ð°ÑÑ‚Ð°Ð²! ðŸ”’',
                dayOpened: 'Ð”ÐµÐ½ÑŒ {day} Ð²Ð¶Ðµ Ð²Ñ–Ð´ÐºÑ€Ð¸Ñ‚Ð¾! ðŸŽ„',
                orbRotating: 'ÐšÑƒÐ»Ñ Ð¾Ð±ÐµÑ€Ñ‚Ð°Ñ”Ñ‚ÑŒÑÑ... Ð’Ð¸Ð±ÐµÑ€Ð¸ Ð´ÐµÐ½ÑŒ!',
                dayUnlocked: 'Ð”ÐµÐ½ÑŒ {day} Ð²Ñ–Ð´ÐºÑ€Ð¸Ñ‚Ð¾! "{task}" ðŸŽ‰',
                error: 'ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ð¼Ð°Ñ€ÐºÐµÑ€ Ñ– HTTPS. Ð”ÐµÑ‚Ð°Ð»Ñ– Ð² ÐºÐ¾Ð½ÑÐ¾Ð»Ñ–.'
            }
        };

        // Tasks (EN primary, UA in object)
        const tasks = {
            en: [
                "Light a candle ðŸ•¯ï¸", "Write to Santa ðŸ“", "Photo with tree ðŸ“¸", "Sing a song ðŸŽµ", "Hug someone ðŸ¤—",
                "Compliment a stranger ðŸ’¬", "Sticker smile ðŸŽ€", "Bird feeder ðŸ¦", "Help neighbor ðŸ›’", "Anonymous gift ðŸŽ",
                "Window drawing â„ï¸", "Winter poem ðŸ“–", "Tree ornament âœ‚ï¸", "New tradition ðŸŒŸ", "AR video ðŸŽ¥", "Dance! ðŸ’ƒ",
                "Joke ðŸ˜‚", "Filter selfie ðŸ˜Ž", "5 red things â¤ï¸", "Mini-disco ðŸ•º", "3 gratitudes ðŸ™", "Cocoa â˜•",
                "Christmas movie ðŸŽ¬", "Gifts under tree ðŸŽ„", "Merry Christmas! ðŸŽ‰"
            ],
            uk: [
                "Ð—Ð°Ð¿Ð°Ð»Ð¸ ÑÐ²Ñ–Ñ‡ÐºÑƒ ðŸ•¯ï¸", "ÐÐ°Ð¿Ð¸ÑˆÐ¸ Ð»Ð¸ÑÑ‚Ð° Ð¡Ð°Ð½Ñ‚Ñ– ðŸ“", "Ð—Ñ€Ð¾Ð±Ð¸ Ñ„Ð¾Ñ‚Ð¾ Ð· ÑÐ»Ð¸Ð½ÐºÐ¾ÑŽ ðŸ“¸",
                "Ð¡Ð¿Ñ–Ð²Ð°Ð¹ Ð¿Ñ–ÑÐ½ÑŽ ðŸŽµ", "ÐžÐ±Ñ–Ð¹Ð¼Ð¸ ÐºÐ¾Ð³Ð¾ÑÑŒ ðŸ¤—", "ÐŸÐ¾Ð´Ð°Ñ€ÑƒÐ¹ ÐºÐ¾Ð¼Ð¿Ð»Ñ–Ð¼ÐµÐ½Ñ‚ ðŸ’¬",
                "ÐÐ°ÐºÐ»ÐµÐ¹ Ð¿Ð¾ÑÐ¼Ñ–ÑˆÐºÑƒ ðŸŽ€", "Ð“Ð¾Ð´Ñ–Ð²Ð½Ð¸Ñ‡ÐºÐ° Ð´Ð»Ñ Ð¿Ñ‚Ð°Ñ…Ñ–Ð² ðŸ¦", "Ð”Ð¾Ð¿Ð¾Ð¼Ð¾Ð¶Ð¸ ÑÑƒÑÑ–Ð´Ñƒ ðŸ›’",
                "ÐÐ½Ð¾Ð½Ñ–Ð¼Ð½Ð¸Ð¹ Ð¿Ð¾Ð´Ð°Ñ€ÑƒÐ½Ð¾Ðº ðŸŽ", "ÐœÐ°Ð»ÑŽÐ½Ð¾Ðº Ð½Ð° Ð²Ñ–ÐºÐ½Ñ– â„ï¸", "Ð’Ñ–Ñ€Ñˆ Ð¿Ñ€Ð¾ Ð·Ð¸Ð¼Ñƒ ðŸ“–",
                "Ð¯Ð»Ð¸Ð½ÐºÐ¾Ð²Ð° Ð¿Ñ€Ð¸ÐºÑ€Ð°ÑÐ° âœ‚ï¸", "ÐÐ¾Ð²Ð° Ñ‚Ñ€Ð°Ð´Ð¸Ñ†Ñ–Ñ ðŸŒŸ", "AR-Ð²Ñ–Ð´ÐµÐ¾ ðŸŽ¥", "Ð¢Ð°Ð½Ñ†ÑŽÐ¹! ðŸ’ƒ",
                "ÐÐ½ÐµÐºÐ´Ð¾Ñ‚ ðŸ˜‚", "Ð¡ÐµÐ»Ñ„Ñ– Ð· Ñ„Ñ–Ð»ÑŒÑ‚Ñ€Ð¾Ð¼ ðŸ˜Ž", "5 Ñ‡ÐµÑ€Ð²Ð¾Ð½Ð¸Ñ… Ñ€ÐµÑ‡ÐµÐ¹ â¤ï¸", "ÐœÑ–Ð½Ñ–-Ð´Ð¸ÑÐºÐ¾ ðŸ•º",
                "3 Ñ€ÐµÑ‡Ñ– Ð²Ð´ÑÑ‡Ð½Ð¾ÑÑ‚Ñ– ðŸ™", "ÐšÐ°ÐºÐ°Ð¾ â˜•", "Ð Ñ–Ð·Ð´Ð²ÑÐ½Ð¸Ð¹ Ñ„Ñ–Ð»ÑŒÐ¼ ðŸŽ¬", "ÐŸÐ¾Ð´Ð°Ñ€ÑƒÐ½ÐºÐ¸ Ð¿Ñ–Ð´ ÑÐ»Ð¸Ð½ÐºÑƒ ðŸŽ„",
                "Ð— Ð Ñ–Ð·Ð´Ð²Ð¾Ð¼! ðŸŽ‰"
            ]
        };

        let currentLang = navigator.language.startsWith('uk') ? 'uk' : 'en';
        let isRotating = false;
        let hasOpenedToday = false;

        // Update UI
        function updateUI() {
            const t = translations[currentLang];
            document.getElementById('title').innerText = t.title;
            document.getElementById('today-line').innerText = t.todayLine;
            document.getElementById('instruction').innerText = t.instruction;
            document.getElementById('lang-toggle').innerText = currentLang === 'en' ? 'ðŸ‡ºðŸ‡¦ UA' : 'EN';
        }

        // Toggle lang (reload for simplicity)
        document.getElementById('lang-toggle').addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'uk' : 'en';
            updateUI();
            location.reload();
        });

        (async () => {
            try {
                updateUI();

                // Date logic (November 6, 2025 -> unlocked=0)
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonth = today.getMonth() + 1;
                const adventMonth = 12;
                const totalDays = 25;
                let unlockedDays = (currentMonth === adventMonth && currentDay <= totalDays) 
                    ? currentDay : (currentMonth > adventMonth ? totalDays : 0);
                // unlockedDays = 5; // For testing
                document.getElementById('today').innerText = unlockedDays || translations[currentLang].todayWait;

                // MindAR init
                const mindarThree = new window.MINDAR.IMAGE.MindARThree({
                    container: document.body,
                    imageTargetSrc: './card.mind',
                    maxTrack: 1
                });
                const { renderer, scene, camera } = mindarThree;

                // Glass orb
                const sphere = new THREE.Mesh(
                    new THREE.SphereGeometry(0.12, 64, 64),
                    new THREE.MeshPhysicalMaterial({
                        color: 0xffffff,
                        transparent: true,
                        opacity: 0.25,
                        metalness: 0.95,
                        roughness: 0.05,
                        transmission: 0.98,
                        thickness: 0.1,
                        clearcoat: 1.0,
                        clearcoatRoughness: 0.1
                    })
                );
                sphere.position.z = 0.02;

                // Ring container
                const ring = new THREE.Group();
                const radius = 0.22;
                const cards = [];
                const currentTasks = tasks[currentLang];

                for (let i = 0; i < totalDays; i++) {
                    const day = i + 1;
                    const canvas = document.createElement('canvas');
                    canvas.width = 256;
                    canvas.height = 128;
                    const ctx = canvas.getContext('2d');

                    // Background gradient
                    const gradient = ctx.createLinearGradient(0, 0, 0, 128);
                    gradient.addColorStop(0, day <= unlockedDays ? '#3a7bd5' : '#666');
                    gradient.addColorStop(1, day <= unlockedDays ? '#00d2ff' : '#333');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 256, 128);

                    // Border
                    ctx.strokeStyle = day <= unlockedDays ? '#ffd700' : '#888';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(2, 2, 252, 124);

                    // Text: Day
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 32px "Playfair Display"';
                    ctx.textAlign = 'center';
                    ctx.fillText(currentLang === 'en' ? `Day ${day}` : `Ð”ÐµÐ½ÑŒ ${day}`, 128, 48);

                    // Task text
                    ctx.font = '20px "Caveat"';
                    ctx.fillStyle = day <= unlockedDays ? 'white' : '#ccc';
                    const taskText = currentTasks[i] || (currentLang === 'en' ? `Task ${day}` : `Ð—Ð°Ð²Ð´Ð°Ð½Ð½Ñ ${day}`);
                    wrapText(ctx, taskText, 240, 20).forEach((line, j) => {
                        ctx.fillText(line, 128, 86 + j * 25);
                    });

                    // Icon
                    ctx.font = 'bold 40px Arial';
                    ctx.fillText(day <= unlockedDays ? 'ðŸŽ„' : 'ðŸ”’', 128, 110);

                    const texture = new THREE.CanvasTexture(canvas);
                    const card = new THREE.Mesh(
                        new THREE.PlaneGeometry(0.08, 0.04),
                        new THREE.MeshBasicMaterial({
                            map: texture,
                            transparent: true,
                            opacity: 0.9,
                            side: THREE.DoubleSide
                        })
                    );

                    // Position in spiral ring
                    const angle = (i / totalDays) * Math.PI * 2;
                    card.position.set(
                        Math.cos(angle) * radius,
                        Math.sin(angle * 2) * 0.1, // Wave
                        Math.sin(angle) * radius
                    );
                    card.lookAt(0, 0, 0);
                    card.userData = { day, unlocked: day <= unlockedDays };
                    ring.add(card);
                    cards.push(card);
                }

                // Anchor
                const anchor = mindarThree.addAnchor(0);
                anchor.group.add(sphere);
                anchor.group.add(ring);

                // Raycaster for interaction
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                window.addEventListener('click', (e) => {
                    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects(cards);
                    const t = translations[currentLang];

                    if (intersects.length > 0) {
                        const clicked = intersects[0].object;
                        const day = clicked.userData.day;
                        if (!clicked.userData.unlocked) {
                            showMessage(t.dayLocked.replace('{day}', day));
                            return;
                        }
                        if (day === currentDay && !hasOpenedToday) {
                            openDay(clicked, day);
                            hasOpenedToday = true;
                        } else if (day < currentDay) {
                            showMessage(t.dayOpened.replace('{day}', day));
                        }
                    } else {
                        const sphereHit = raycaster.intersectObject(sphere);
                        if (sphereHit.length > 0 && !isRotating) {
                            isRotating = true;
                            setTimeout(() => { isRotating = false; }, 5000);
                            showMessage(t.orbRotating);
                        }
                    }
                });

                // Open day animation
                function openDay(card, day) {
                    const clone = card.clone();
                    clone.position.copy(card.position);
                    scene.add(clone);
                    let time = 0;
                    const dur = 1500;
                    const startY = clone.position.y;
                    const anim = () => {
                        time += 16;
                        const prog = Math.min(time / dur, 1);
                        const ease = 1 - Math.pow(1 - prog, 3);
                        clone.scale.setScalar(1 + ease * 2);
                        clone.position.y = startY - ease * 0.3;
                        clone.material.opacity = 1 - ease;
                        if (prog < 1) requestAnimationFrame(anim);
                        else {
                            scene.remove(clone);
                            showMessage(translations[currentLang].dayUnlocked.replace('{day}', day).replace('{task}', currentTasks[day - 1]), 4000);
                            card.visible = false;
                        }
                    };
                    anim();
                }

                // Wrap text
                function wrapText(ctx, text, maxW, fontSize) {
                    ctx.font = `${fontSize}px "Caveat"`;
                    const words = text.split(' ');
                    const lines = [];
                    let line = '';
                    words.forEach(w => {
                        const test = line + w + ' ';
                        if (ctx.measureText(test).width > maxW) {
                            lines.push(line.trim());
                            line = w + ' ';
                        } else line = test;
                    });
                    lines.push(line.trim());
                    return lines;
                }

                // Show message
                function showMessage(text, timeout = 2000) {
                    const info = document.getElementById('info');
                    info.innerHTML += `<div style="margin-top:10px;">${text}</div>`;
                    setTimeout(() => updateUI(), timeout);
                }

                await mindarThree.start();
                renderer.setAnimationLoop(() => {
                    if (isRotating) ring.rotation.y += 0.01;
                    else ring.rotation.y += 0.005;
                    renderer.render(scene, camera);
                });
            } catch (e) {
                console.error(e);
                document.getElementById('info').innerHTML = translations[currentLang].error;
            }
        })();
    </script>
</body>
</html>
