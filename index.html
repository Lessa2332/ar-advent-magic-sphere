<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Безпечна CSP політика без unsafe-eval -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://aframe.io https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://aframe.io https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; media-src 'self' data: blob: https:; connect-src 'self'">
    <title>Передай лист Санті</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body{margin:0;overflow:hidden;background:#0a1e3a;font-family:sans-serif}
        #startScreen,#loading{position:fixed;inset:0;background:linear-gradient(135deg,#0f3443,#1e5a7e);
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            text-align:center;color:white;z-index:100}
        h1{font-size:2.8em;color:#ffd700;text-shadow:0 0 20px gold;margin-bottom:20px}
        button{background:#e74c3c;color:white;border:none;padding:18px 50px;font-size:1.6em;
               border-radius:50px;box-shadow:0 10px 30px rgba(231,76,60,.6);cursor:pointer;transition:.2s}
        button:active{transform:scale(0.95)}
        #hint{position:absolute;top:15px;left:50%;transform:translateX(-50%);
              background:#000000cc;padding:12px 30px;border-radius:20px;font-size:1.7em;
              z-index:10;pointer-events:none;max-width:90%;text-align:center}
        #sendBtn{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);
                 background:#27ae60;padding:20px 60px;font-size:2em;border-radius:50px;
                 z-index:20;display:none;cursor:pointer}
        .hidden{display:none!important}
        
        /* Додаємо pointer-events для кнопки в хінті */
        #hint button {pointer-events: auto;}
    </style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<div id="loading" class="hidden">Завантаження...</div>

<a-scene id="scene" class="hidden" embedded
         mindar-image="imageTargetSrc: targets.mind; uiLoading:no; uiScanning:no; maxTrack:2"
         vr-mode-ui="enabled:false" renderer="colorManagement:false">

    <a-assets timeout="30000">
        <audio id="waiting" src="waiting.mp3" preload="auto"></audio>
        <audio id="magic" src="magic-sound.mp3" preload="auto"></audio>
        <img id="elfIdle" src="elf-idle.png">
        <img id="elfMagic" src="elf-magic.png">
    </a-assets>

    <a-camera position="0 1.6 0" wasd-controls="enabled: false"></a-camera>

    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>

    <a-entity mindar-image-target="targetIndex: 0" bell-listener></a-entity>

    <a-entity id="starAnchor" mindar-image-target="targetIndex: 1">
        <a-entity id="elfContainer" position="1.4 1.1 -0.8">

            <a-entity id="elfIdleEntity" visible="false">
                <a-plane src="#elfIdle" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 24"
                         animation="property: material.offsetRepeat.y; from:0; to:-23; dur:2880; loop:true"></a-plane>
                <a-sound id="waitingSound" src="#waiting" autoplay="false" loop="true" positional="true"
                         ref-distance="0.4" max-distance="6" rolloff-factor="2" volume="1"></a-sound>
            </a-entity>

            <a-entity id="elfMagicEntity" visible="false">
                <a-plane id="magicPlane" src="#elfMagic" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 36"
                         animation="property: material.offsetRepeat.y; from:0; to:-35; dur:2880; easing:linear; startEvents:playMagic"></a-plane>
                <a-sound id="magicSound" src="#magic" autoplay="false" positional="true"
                         ref-distance="0.3" max-distance="5" volume="1"></a-sound>
            </a-entity>

        </a-entity>
    </a-entity>
</a-scene>

<script>
    let step = 0;
    let animationFrameId = null;
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdleEntity = document.querySelector('#elfIdleEntity');
    const elfMagicEntity = document.querySelector('#elfMagicEntity');
    const waitingSound = document.querySelector('#waitingSound');
    const magicSound = document.querySelector('#magicSound');
    const magicPlane = document.querySelector('#magicPlane');

    // Функція для безпечного створення кнопки "Заново"
    function createRestartButton() {
        const btn = document.createElement('button');
        btn.textContent = 'Заново';
        btn.id = 'restartBtn';
        btn.style.cssText = 'margin-top:20px;padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer';
        btn.addEventListener('click', function() {
            location.reload();
        });
        return btn;
    }

    // Функція оновлення позиції та звуку
    function updatePosition() {
        if (step === 2 && document.querySelector('#elfContainer') && document.querySelector('#elfContainer').object3D && document.querySelector('#elfContainer').object3D.visible) {
            const camera = document.querySelector('a-camera').object3D;
            const pos = new THREE.Vector3();
            document.querySelector('#elfContainer').object3D.getWorldPosition(pos);
            const dist = camera.position.distanceTo(pos);

            // Оновлення гучності звуку очікування
            if (waitingSound && waitingSound.components && waitingSound.components.sound && waitingSound.components.sound.isPlaying) {
                const vol = Math.max(0.1, Math.min(1, 1 - dist/4));
                waitingSound.setAttribute('sound', 'volume', vol);
            }

            // Перевірка близькості для показу ельфа та кнопки
            const near = dist < 0.5;
            if (elfIdleEntity) {
                elfIdleEntity.setAttribute('visible', near);
            }
            sendBtn.style.display = near ? 'block' : 'none';
        }
        
        if (step !== 3) { // Зупиняємо анімаційний цикл тільки якщо не завершили
            animationFrameId = requestAnimationFrame(updatePosition);
        }
    }

    // Реєстрація компонента для слухача дзвіночка
    AFRAME.registerComponent('bell-listener', {
        init: function(){
            this.el.addEventListener('targetFound', function() {
                if (step === 0) { 
                    step = 1; 
                    hint.textContent = "Чудово! Тепер зірочку!"; 
                }
            });
        }
    });

    // Обробник кнопки старту
    document.getElementById('startBtn').addEventListener('click', function() {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        
        // Використовуємо функцію замість строки в setTimeout
        setTimeout(function() {
            document.getElementById('scene').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }, 1500);
    });

    // Обробники для зірочки
    const starAnchor = document.querySelector('#starAnchor');
    
    if (starAnchor) {
        starAnchor.addEventListener('targetFound', function() {
            if (step !== 1) return;
            step = 2;
            hint.textContent = "Я десь поруч… підійди ближче, почуєш!";
            
            // Затримка для ініціалізації звуку
            setTimeout(function() {
                if (waitingSound && waitingSound.components && waitingSound.components.sound) {
                    waitingSound.components.sound.playSound();
                }
                // Запускаємо анімаційний цикл
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                animationFrameId = requestAnimationFrame(updatePosition);
            }, 500);
        });

        starAnchor.addEventListener('targetLost', function() {
            sendBtn.style.display = 'none';
            if (elfIdleEntity) {
                elfIdleEntity.setAttribute('visible', false);
            }
            if (waitingSound && waitingSound.components && waitingSound.components.sound) {
                waitingSound.components.sound.stopSound();
            }
        });
    }

    // Обробник кнопки відправки
    sendBtn.addEventListener('click', function() {
        step = 3; // Позначаємо завершення для зупинки анімації
        sendBtn.style.display = 'none';
        
        if (elfIdleEntity) {
            elfIdleEntity.setAttribute('visible', false);
        }
        
        // Зупинка звуку очікування
        if (waitingSound && waitingSound.components && waitingSound.components.sound) {
            waitingSound.components.sound.stopSound();
        }

        // Зупинка анімаційного циклу
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }

        // Запуск магічної анімації
        if (elfMagicEntity) {
            elfMagicEntity.setAttribute('visible', true);
        }
        
        if (magicSound && magicSound.components && magicSound.components.sound) {
            magicSound.components.sound.playSound();
        }
        
        if (magicPlane) {
            magicPlane.emit('playMagic');
        }

        hint.innerHTML = "Я передав твоє бажання Санті!<br>Вітаю з Різдвом!";

        // Додавання кнопки "Заново" після завершення
        setTimeout(function() {
            if (elfMagicEntity) {
                elfMagicEntity.setAttribute('visible', false);
            }
            const restartBtn = createRestartButton();
            hint.appendChild(restartBtn);
        }, 4000);
    });

    // Обробник завантаження сцени
    document.querySelector('a-scene').addEventListener('loaded', function() {
        console.log('A-Frame scene loaded successfully');
    });
</script>
</body>
</html>
