<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval' blob:; worker-src * blob: data:; connect-src *; img-src * data: blob:; style-src * 'unsafe-inline';">
    <title>Передай лист Санті</title>
    
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* ТВОЇ СТИЛІ ТУТ */
    </style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<div id="loading" class="hidden">Завантаження...</div>

<a-scene id="scene" class="hidden" embedded
         mindar-image="imageTargetSrc: targets.mind; uiLoading:no; uiScanning:no; maxTrack:2"
         vr-mode-ui="enabled:false" renderer="colorManagement:false">

    <a-assets timeout="15000">
        <audio id="waiting" src="waiting.mp3" preload="auto"></audio>
        <audio id="magic" src="magic-sound.mp3" preload="auto"></audio>
        <img id="elfIdle" src="elf-idle.png">
        <img id="elfMagic" src="elf-magic.png">
    </a-assets>

    <a-camera position="0 1.6 0" wasd-controls="enabled: false"></a-camera>

    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>

    <a-entity mindar-image-target="targetIndex: 0" bell-listener></a-entity>

    <a-entity id="starAnchor" mindar-image-target="targetIndex: 1">
        <a-entity id="elfContainer" position="1.4 1.1 -0.8">

            <a-entity id="elfIdle" visible="false">
                <a-plane src="#elfIdle" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 24"
                         animation="property: material.offsetRepeat.y; from:0; to:-23; dur:2880; loop:true; easing:linear">
                </a-plane>
                <a-sound src="#waiting" autoplay="false" loop="true" positional="true"
                         ref-distance="0.4" max-distance="6" rolloff-factor="2" volume="1"></a-sound>
            </a-entity>

            <a-entity id="elfMagic" visible="false">
                <a-plane src="#elfMagic" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 36"
                         animation="property: material.offsetRepeat.y; from:0; to:-35; dur:2880; easing:linear; startEvents:playMagic">
                </a-plane>
                <a-sound src="#magic" autoplay="false" positional="true"
                         ref-distance="0.3" max-distance="5" volume="1"></a-sound>
            </a-entity>

        </a-entity>
    </a-entity>
</a-scene>

<script>
    let step = 0;
    let audioUnlocked = false;
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdle = document.querySelector('#elfIdle');
    const elfMagic = document.querySelector('#elfMagic');
    const elfContainer = document.querySelector('#elfContainer');
    const waitingSound = elfIdle.querySelector('a-sound');
    const magicSound = elfMagic.querySelector('a-sound');
    const magicPlane = elfMagic.querySelector('a-plane');

    // РОЗБЛОКУВАННЯ АУДІО ПРИ КЛІЦІ
    function unlockAudio() {
        if (audioUnlocked) return;
        
        // Створюємо тимчасовий аудіо елемент для розблокування
        const tempAudio = new Audio();
        tempAudio.volume = 0.001; // Майже безшумний
        const silentSource = tempAudio.context.createOscillator();
        silentSource.connect(tempAudio.context.destination);
        silentSource.start(0);
        silentSource.stop(0.001);
        
        audioUnlocked = true;
        console.log("Аудіо розблоковано!");
    }

    // Розблокувати аудіо при будь-якому кліці
    document.addEventListener('click', unlockAudio);
    document.addEventListener('touchstart', unlockAudio);

    AFRAME.registerComponent('bell-listener', {
        init: function(){
            this.el.addEventListener('targetFound', () => {
                if (step === 0) {
                    step = 1;
                    hint.textContent = "Чудово! Тепер зірочку!";
                    unlockAudio();
                }
            });
        }
    });

    document.getElementById('startBtn').onclick = () => {
        unlockAudio();
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('loading').classlist.remove('hidden');
        
        setTimeout(() => {
            document.getElementById('scene').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }, 1000);
    };

    document.querySelector('#starAnchor').addEventListener('targetFound', () => {
        if (step !== 1) return;
        step = 2;
        hint.textContent = "Я десь поруч… підійди ближче, почуєш!";
        
        // Спроба відтворити звук з затримкою
        setTimeout(() => {
            if (audioUnlocked && waitingSound.components.sound) {
                try {
                    waitingSound.components.sound.playSound();
                    console.log("Звук ельфа запущено!");
                } catch (error) {
                    console.log("Не вдалося запустити звук:", error);
                    // Альтернативний спосіб
                    try {
                        const audio = new Audio('waiting.mp3');
                        audio.loop = true;
                        audio.volume = 0.7;
                        audio.play();
                    } catch (e) {
                        console.log("Альтернативний звук теж не працює");
                    }
                }
            }
        }, 500);
    });

    // Решта коду залишається без змін...
    document.querySelector('#starAnchor').addEventListener('targetLost', () => {
        sendBtn.style.display = 'none';
        elfIdle.setAttribute('visible', false);
    });

    document.querySelector('a-scene').addEventListener('renderstart', () => {
        const camera = document.querySelector('a-camera').object3D;
        const update = () => {
            if (step === 2 && elfContainer.object3D.visible) {
                const pos = new THREE.Vector3();
                elfContainer.object3D.getWorldPosition(pos);
                const dist = camera.position.distanceTo(pos);

                if (waitingSound.components.sound && waitingSound.components.sound.isPlaying) {
                    const vol = Math.max(0.1, Math.min(1, 1 - dist/4));
                    waitingSound.setAttribute('sound', 'volume', vol);
                }

                const near = dist < 0.5;
                elfIdle.setAttribute('visible', near);
                sendBtn.style.display = near ? 'block' : 'none';
            }
            requestAnimationFrame(update);
        };
        update();
    });

    sendBtn.onclick = () => {
        unlockAudio();
        sendBtn.style.display = 'none';
        elfIdle.setAttribute('visible', false);
        
        if (waitingSound.components.sound) {
            waitingSound.components.sound.stopSound();
        }

        elfMagic.setAttribute('visible', true);
        
        setTimeout(() => {
            if (magicSound.components.sound) {
                magicSound.components.sound.playSound();
            }
        }, 100);
        
        magicPlane.emit('playMagic');

        hint.innerHTML = "Я передав твоє бажання Санті!<br>Вітаю з Різдвом!";

        setTimeout(() => {
            elfMagic.setAttribute('visible', false);
            const btn = document.createElement('button');
            btn.textContent = 'Заново';
            btn.style.cssText = 'margin-top:20px;padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer';
            btn.onclick = () => location.reload();
            hint.appendChild(btn);
        }, 4000);
    };
</script>
</body>
</html>
