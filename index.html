<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Magical Snow Globe AR</title>

  <!-- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤ —É URL -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
      touch-action: none;
    }
    .container {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    #ar-container {
      width: 100%;
      height: 100%;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      color: white;
      background: rgba(0,0,0,0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid #4a90e2;
      min-width: 280px;
    }
    .loading h3 {
      margin: 0 0 15px 0;
      color: #4a90e2;
    }
    .loading p {
      margin: 8px 0;
      font-size: 16px;
    }
    .loading .small {
      font-size: 14px;
      color: #ccc;
    }
    .error {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 1001;
      color: red;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 8px;
      display: none;
      border: 1px solid red;
    }
    .music-control {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1002;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      border: 2px solid #4a90e2;
    }
    .music-control:hover {
      background: rgba(74, 144, 226, 0.3);
    }
    .music-control.playing {
      background: rgba(74, 144, 226, 0.5);
    }
  </style>
</head>
<body>
  <div class="error" id="error"></div>
  <button class="music-control" id="musicButton">üîá –£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É</button>

  <div class="loading" id="loading">
    <h3>üîÆ –ú–∞–≥—ñ—á–Ω–∞ –∫—É–ª—è</h3>
    <p><strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</strong></p>
    <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
    <p class="small">–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</p>
  </div>

  <!-- ‚úÖ –î–æ–¥–∞–Ω–æ cursor + raycaster –¥–ª—è –∫–ª—ñ–∫—É -->
  <a-scene
    id="scene"
    embedded
    mindar-image="imageTargetSrc: ./card.mind; autoStart: true; maxTrack: 1;"
    color-space="sRGB"
    renderer="colorManagement: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    cursor="rayOrigin: mouse"
    raycaster="objects: .clickable">

    <!-- –ê—É–¥—ñ–æ (—è–∫—â–æ –Ω–µ –ø—Ä–∞—Ü—é—î ‚Äî –∑–∞–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –Ω–∞ —á–∞—Å —Ç–µ—Å—Ç—É) -->
    <a-assets timeout="8000">
      <audio id="backgroundMusic" src="./fon1.mp3" preload="auto" crossorigin></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <a-entity id="background-audio" sound="src: #backgroundMusic; volume: 0.5"></a-entity>

    <a-entity mindar-image-target="targetIndex: 0">
      <!-- ‚úÖ –ö—É–ª—è –∑ –∫–ª–∞—Å–æ–º clickable -->
      <a-sphere
        id="magic-sphere"
        radius="0.4"
        position="0 0.5 0"
        color="#aaddff"
        opacity="0.4"
        transparent="true"
        shader="flat"
        class="clickable">
      </a-sphere>

      <!-- –ü—ñ–¥—Å—Ç–∞–≤–∫–∞ -->
      <a-cylinder
        radius="0.45"
        height="0.05"
        position="0 -0.1 0"
        color="#888888"
        opacity="0.8">
      </a-cylinder>

      <!-- ‚úÖ –¢–µ–∫—Å—Ç –∑ look-at —ñ –≤–∏–¥–∏–º—ñ—Å—Ç—é -->
      <a-text
        id="magic-text"
        value="–¢–æ—Ä–∫–Ω–∏—Å—è –∫—É–ª—ñ!"
        position="0 1.0 0"
        align="center"
        color="#ffffff"
        width="2.5"
        look-at="[camera]"
        visible="true">
      </a-text>
    </a-entity>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loading = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const musicButton = document.getElementById('musicButton');
      const scene = document.getElementById('scene');

      let isMusicPlaying = false;
      let audioEntity = null;
      let isRotating = false;
      let snowflakes = [];
      let animationId = null;
      let snowSystem = null;

      const texts = [
        "–ë–∞–∂–∞—é —É–¥–∞—á—ñ!", "–¢–≤–æ—è –º—Ä—ñ—è –∑–±—É–¥–µ—Ç—å—Å—è", "–ú–∞–≥—ñ—è –ø–æ—Ä—É—á", "–°—è–π —è—Å–∫—Ä–∞–≤—ñ—à–µ",
        "–ú—Ä—ñ–π —Å–º—ñ–ª–∏–≤—ñ—à–µ", "–•–æ–ª–æ–¥–Ω–∞ –ø—Ä–∞–≤–¥–∞", "–ì–∞—Ä—è—á–µ –±–∞–∂–∞–Ω–Ω—è", "–ß–∏—Å—Ç—ñ –¥—É–º–∫–∏",
        "–ó–º—ñ–Ω–Ω–∏–π –≤—ñ—Ç–µ—Ä", "–¢–∞—î–º–Ω–∏—á–∞ –Ω—ñ—á", "–Ø—Å–Ω–∏–π –¥–µ–Ω—å", "–®–≤–∏–¥–∫–∞ –¥—ñ—è",
        "–ß–∞—Ä—ñ–≤–Ω–∞ —Å–∏–ª–∞", "–í—ñ—â—É–π –º–∞–π–±—É—Ç–Ω—î", "–°–≤—è—Ç–∫–æ–≤–∏–π –Ω–∞—Å—Ç—Ä—ñ–π"
      ];
      let currentTextIndex = 0;

      // –ü–æ–∫–∞–∑ –ø–æ–º–∏–ª–∫–∏
      function showError(msg) {
        if (errorEl) {
          errorEl.textContent = `‚ùå ${msg}`;
          errorEl.style.display = 'block';
        }
        console.error(msg);
      }

      // –ú—É–∑–∏–∫–∞ (–º–æ–∂–Ω–∞ —Ç–∏–º—á–∞—Å–æ–≤–æ –≤–∏–º–∫–Ω—É—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç—É)
      function setupMusicControl() {
        musicButton.addEventListener('click', () => {
          const audioEl = document.getElementById('backgroundMusic');
          if (!audioEntity) {
            audioEntity = document.querySelector('#background-audio');
          }

          if (!audioEl || !audioEntity?.components?.sound) {
            showError('–ê—É–¥—ñ–æ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
            return;
          }

          if (audioEl.readyState < 2) {
            showError('–ú—É–∑–∏–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...');
            return;
          }

          if (isMusicPlaying) {
            audioEntity.components.sound.stopSound();
            musicButton.textContent = 'üîá –£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É';
            musicButton.classList.remove('playing');
          } else {
            audioEntity.components.sound.playSound();
            musicButton.textContent = 'üîä –í–∏–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É';
            musicButton.classList.add('playing');
          }
          isMusicPlaying = !isMusicPlaying;
        });
      }

      // ‚úÖ –°–Ω—ñ–∂–∏–Ω–∫–∏ ‚Äî –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫—É–ª—ñ
      function createSnowflakes() {
        snowSystem = document.createElement('a-entity');
        snowSystem.setAttribute('position', '0 0.5 0');
        scene.appendChild(snowSystem);

        for (let i = 0; i < 30; i++) {
          const flake = document.createElement('a-sphere');
          const size = 0.008 + Math.random() * 0.015;
          const x = (Math.random() - 0.5) * 0.7;
          const y = (Math.random() - 0.5) * 0.7;
          const z = (Math.random() - 0.5) * 0.7;

          flake.setAttribute('radius', size);
          flake.setAttribute('color', 'white');
          flake.setAttribute('opacity', 0.7);
          flake.setAttribute('position', `${x} ${y} ${z}`);
          flake.dataset.speed = (0.1 + Math.random() * 0.2).toString();
          flake.dataset.angle = (Math.random() * Math.PI * 2).toString();
          snowSystem.appendChild(flake);
          snowflakes.push(flake);
        }
      }

      // ‚úÖ –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–Ω—ñ–∂–∏–Ω–æ–∫ –∑ –æ–±–º–µ–∂–µ–Ω–Ω—è–º —É –∫—É–ª—ñ
      function animateSnow(timestamp) {
        if (snowflakes.length === 0) {
          animationId = requestAnimationFrame(animateSnow);
          return;
        }

        const time = timestamp * 0.001;
        const maxRadius = 0.38; // —Ç—Ä–æ—Ö–∏ –º–µ–Ω—à–µ –∑–∞ –∫—É–ª—é (0.4)

        for (let i = 0; i < snowflakes.length; i++) {
          const flake = snowflakes[i];
          const speed = parseFloat(flake.dataset.speed);
          const angle = parseFloat(flake.dataset.angle);
          const pos = flake.getAttribute('position');

          // –ü–∞–¥—ñ–Ω–Ω—è
          let newY = pos.y - 0.008 * speed;
          if (newY < -0.35) newY = 0.35;

          // –ö–æ–ª–∏–≤–∞–Ω–Ω—è
          const swingX = Math.sin(time * speed + angle) * 0.012;
          const swingZ = Math.cos(time * speed * 0.8 + angle) * 0.012;
          let newX = pos.x + swingX;
          let newZ = pos.z + swingZ;

          // üîí –¢—Ä–∏–º–∞—î–º–æ —Å–Ω—ñ–∂–∏–Ω–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫—É–ª—ñ
          const dx = newX;
          const dy = newY - 0.5;
          const dz = newZ;
          const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
          if (dist > maxRadius) {
            const scale = maxRadius / dist * 0.98;
            newX = dx * scale;
            newZ = dz * scale;
            newY = 0.5 + dy * scale;
          }

          flake.setAttribute('position', `${newX} ${newY} ${newZ}`);
          flake.setAttribute('rotation', 
            `${time * 20 * speed} ${time * 30 * speed} ${time * 25 * speed}`
          );
          const flicker = 0.5 + Math.sin(time * 3 + angle) * 0.3;
          flake.setAttribute('opacity', (0.5 * flicker).toFixed(2));
          flake.dataset.angle = (angle + 0.01).toString();
        }

        animationId = requestAnimationFrame(animateSnow);
      }

      // ‚úÖ –ù–∞–¥—ñ–π–Ω–∏–π –∫–ª—ñ–∫ (–ø—Ä–∞—Ü—é—î –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö)
      function setupClickHandler() {
        const sphere = document.getElementById('magic-sphere');
        const text = document.getElementById('magic-text');
        if (!sphere || !text) {
          setTimeout(setupClickHandler, 500);
          return;
        }

        const handleClick = () => {
          if (isRotating) return;
          isRotating = true;

          text.setAttribute('animation__rotate', {
            property: 'rotation',
            to: `0 ${parseInt(text.getAttribute('rotation').y || 0) + 360} 0`,
            dur: 800,
            easing: 'easeOutCubic'
          });

          setTimeout(() => {
            currentTextIndex = (currentTextIndex + 1) % texts.length;
            text.setAttribute('value', texts[currentTextIndex]);
            isRotating = false;
          }, 800);
        };

        sphere.addEventListener('click', handleClick);
        sphere.addEventListener('touchstart', (e) => {
          e.preventDefault();
          handleClick();
        });
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
      if (!navigator.mediaDevices?.getUserMedia) {
        showError('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –°–ø—Ä–æ–±—É–π—Ç–µ Chrome –∞–±–æ Safari.');
      }
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        showError('–ü–æ—Ç—Ä—ñ–±–µ–Ω HTTPS (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, GitHub Pages).');
      }

      // ‚úÖ –ì–æ–ª–æ–≤–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
      if (!scene) {
        showError('–°—Ü–µ–Ω–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
        return;
      }

      scene.addEventListener('loaded', () => {
        console.log('‚úÖ AR –≥–æ—Ç–æ–≤–∏–π');
        loading.style.display = 'none';

        setupMusicControl();
        createSnowflakes();
        animationId = requestAnimationFrame(animateSnow);
        setTimeout(setupClickHandler, 1200); // –¥–∞—î–º–æ —á–∞—Å –Ω–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤
      });

      scene.addEventListener('error', (e) => {
        showError('AR –ø–æ–º–∏–ª–∫–∞: ' + (e.detail?.message || '–Ω–µ–≤—ñ–¥–æ–º–∞'));
      });
    });
  </script>
</body>
</html>
