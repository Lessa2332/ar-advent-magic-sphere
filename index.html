<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Передай лист Санті</title>
<style>
    body { margin:0; overflow:hidden; background:#0a1e3a; color:white; font-family:sans-serif; }
    #startScreen { position:fixed; inset:0; background:linear-gradient(135deg,#0f3443,#1e5a7e); display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; z-index:100; }
    h1 { font-size:2.8em; color:#ffd700; text-shadow:0 0 20px gold; margin-bottom:20px; }
    button { background:#e74c3c; color:white; border:none; padding:18px 50px; font-size:1.6em; border-radius:50px; margin-top:30px; box-shadow:0 10px 30px rgba(231,76,60,.6); cursor:pointer; transition:0.2s; }
    button:active { transform:scale(0.95); }
    #arContainer { position:fixed; inset:0; }
    #hint { position:absolute; top:20px; left:50%; transform:translateX(-50%); background:#000000cc; padding:15px 30px; border-radius:20px; font-size:1.8em; z-index:10; pointer-events:none; }
    #sendBtn { position:absolute; bottom:100px; left:50%; transform:translateX(-50%); padding:20px 60px; font-size:2em; background:#27ae60; border-radius:50px; z-index:20; display:none; }
    #elfIdle, #elfMagic {
        position:absolute; bottom:0; left:50%; transform:translateX(-50%);
        width:90vw; max-width:420px; height:auto; max-height:68vh;
        background-size:100% auto; background-repeat:no-repeat;
        pointer-events:none; opacity:0; transition:opacity 1.2s ease;
        z-index:5;
    }
    #elfMagic { z-index:6; }
    .hidden { display:none; }
</style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати магію</button>
</div>

<div id="arContainer" class="hidden">
    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>
    <div id="elfIdle"></div>
    <div id="elfMagic"></div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
import {MindARThree} from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-three.prod.js';

let mindarThree, anchor2, posAudio, magicSound;
let step = 0;
let pos1 = null;

const hint = document.getElementById('hint');
const sendBtn = document.getElementById('sendBtn');
const elfIdle = document.getElementById('elfIdle');
const elfMagic = document.getElementById('elfMagic');

document.getElementById('startBtn').addEventListener('click', async () => {
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('arContainer').classList.remove('hidden');

    // Створюємо magicSound ТІЛЬКИ після кліку — щоб не блокувався
    magicSound = new Audio('magic-sound.mp3');
    magicSound.volume = 0.9;

    mindarThree = new MindARThree({
        container: document.getElementById('arContainer'),
        imageTargetSrc: './targets.mind',
        uiLoading: 'no',
        uiScanning: 'no'
    });

    const {renderer, scene, camera} = mindarThree;
    const listener = new THREE.AudioListener();
    camera.add(listener);

    posAudio = new THREE.PositionalAudio(listener);
    posAudio.setRefDistance(0.8);
    posAudio.setMaxDistance(10);
    posAudio.setRolloffFactor(2);
    posAudio.setLoop(true);
    const buffer = await new THREE.AudioLoader().loadAsync('waiting.mp3');
    posAudio.setBuffer(buffer);

    const anchor1 = mindarThree.addAnchor(0); // дзвіночок
    anchor2 = mindarThree.addAnchor(1);     // зірочка

    anchor1.onTargetFound = () => {
        if (step === 0) {
            pos1 = anchor1.group.position.clone();
            step = 1;
            hint.textContent = "Чудово! Тепер зірочку!";
        }
    };

    anchor2.onTargetFound = () => {
        if (step !== 1) return;

        // Прив’язуємо звук до другого якоря + зсув на 3 метри вперед
        const dir = new THREE.Vector3();
        anchor2.group.getWorldDirection(dir);
        dir.negate().multiplyScalar(3);

        anchor2.group.add(posAudio);
        posAudio.position.copy(dir);
        posAudio.setVolume(0.3);
        posAudio.play();

        hint.textContent = "Я тут, чекаю твого листа…";
        step = 2;
    };

    // Idle анімація
    let frame = 0;
    setInterval(() => {
        if (elfIdle.style.opacity > 0) {
            frame = (frame + 1) % 24;
            elfIdle.style.backgroundPosition = `0 ${-frame * (100/24)}%`;
        }
    }, 120);

    // Основний цикл
    renderer.setAnimationLoop(() => {
        if (step === 2 && anchor2.group) {
            const distance = camera.position.distanceTo(anchor2.group.getWorldPosition(new THREE.Vector3()));
            posAudio.setVolume(THREE.MathUtils.clamp(1 - distance/5, 0.1, 1));

            if (distance < 0.5 && elfIdle.classList.contains('hidden')) {
                elfIdle.classList.remove('hidden');
                elfIdle.style.background = 'url("elf-idle.png") 0 0 / 100% auto no-repeat';
                setTimeout(() => elfIdle.style.opacity = 1, 50);
                sendBtn.style.display = 'block';
            }
        }
        renderer.render(scene, camera);
    });

    // Магія!
    sendBtn.onclick = () => {
        sendBtn.style.display = 'none';
        elfIdle.style.opacity = 0;

        elfMagic.classList.remove('hidden');
        elfMagic.style.background = 'url("elf-magic.png") 0 0 / 100% auto no-repeat';
        setTimeout(() => {
            elfMagic.style.opacity = 1;
            magicSound.currentTime = 0;
            magicSound.play();
        }, 100);

        hint.textContent = "Я передав твоє бажання Санті! Вітаю з Різдвом!";

        let f = 0;
        const anim = setInterval(() => {
            f++;
            if (f >= 36) { // кількість кадрів у elf-magic.png
                clearInterval(anim);
                setTimeout(() => {
                    elfMagic.style.opacity = 0;
                    hint.innerHTML = 'Я передав твоє бажання Санті!<br><br><button onclick="location.reload()" style="padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px">Розпочати знову</button>';
                }, 1000);
            } else {
                elfMagic.style.backgroundPosition = `0 ${-f * (100/36)}%`;
            }
        }, 80);
    };

    await mindarThree.start();
});
</script>
</body>
</html>
