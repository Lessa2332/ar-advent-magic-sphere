<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Передай лист Санті</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body { margin:0; overflow:hidden; background:#0a1e3a; }
        #startScreen,#loading{position:fixed;inset:0;background:linear-gradient(135deg,#0f3443,#1e5a7e);
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            text-align:center;color:white;font-family:sans-serif;z-index:100;}
        h1{font-size:2.8em;color:#ffd700;text-shadow:0 0 20px gold;margin-bottom:20px;}
        button{background:#e74c3c;color:white;border:none;padding:18px 50px;font-size:1.6em;
               border-radius:50px;box-shadow:0 10px 30px rgba(231,76,60,.6);cursor:pointer;}
        #hint{position:absolute;top:15px;left:50%;transform:translateX(-50%);
              background:#000000cc;padding:12px 30px;border-radius:20px;font-size:1.7em;
              z-index:10;pointer-events:none;max-width:90%;text-align:center;}
        #sendBtn{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);
                 background:#27ae60;padding:20px 60px;font-size:2em;border-radius:50px;
                 z-index:20;display:none;cursor:pointer;}
        .hidden{display:none!important;}
    </style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>
<div id="loading" class="hidden">Завантаження...</div>

<a-scene id="scene" class="hidden" embedded mindar-image="imageTargetSrc: targets.mind; uiLoading:no; uiScanning:no;"
         vr-mode-ui="enabled:false" renderer="colorManagement:false">

    <a-assets>
        <audio id="waiting" src="waiting.mp3" preload="auto"></audio>
        <audio id="magic" src="magic-sound.mp3" preload="auto"></audio>
        <img id="elfIdle" src="elf-idle.png">
        <img id="elfMagic" src="elf-magic.png">
    </a-assets>

    <a-camera position="0 1.6 0"></a-camera>

    <div id="hint">Знайди слід ельфа!</div>
    <button id="sendBtn">Відправити лист</button>

    <!-- Дзвіночок – тільки логіка -->
    <a-entity mindar-image-target="targetIndex: 0" bell-listener></a-entity>

    <!-- Зірочка – просто якір, ельф буде збоку -->
    <a-entity id="starAnchor" mindar-image-target="targetIndex: 1">

        <!-- Ельф + звук розташовані за координатами відносно маркера -->
        <a-entity id="elfContainer" position="1.5 1.0 -0.5">   <!-- ← ЗМІНЮЙ ЦІ КООРДИНАТИ! -->

            <!-- Idle ельф -->
            <a-entity id="elfIdle" visible="false">
                <a-plane src="#elfIdle" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 24"
                         animation="property: material.offsetRepeat.y; from:0; to:-23; dur:2880; loop:true; easing:linear">
                </a-plane>
                <a-sound src="#waiting" autoplay="false" loop="true" positional="true"
                         ref-distance="0.4" max-distance="6" rolloff-factor="2" volume="1"></a-sound>
            </a-entity>

            <!-- Магія -->
            <a-entity id="elfMagic" visible="false">
                <a-plane src="#elfMagic" transparent="true" width="0.8" height="1.6"
                         material="shader: flat; repeat: 1 36"></a-plane>
                <a-sound src="#magic" autoplay="false" positional="true"
                         ref-distance="0.3" max-distance="5" volume="1"></a-sound>
            </a-entity>

        </a-entity>
    </a-entity>
</a-scene>

<script>
    let step = 0;
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdle = document.querySelector('#elfIdle');
    const elfMagic = document.querySelector('#elfMagic');
    const elfContainer = document.querySelector('#elfContainer');
    const waitingSound = elfIdle.querySelector('a-sound');
    const magicSound = elfMagic.querySelector('a-sound');

    // Дзвіночок знайшли
    AFRAME.registerComponent('bell-listener', {init:function(){
        this.el.addEventListener('targetFound',()=>{ if(step===0){step=1;hint.textContent="Чудово! Тепер зірочку!";}});
    }});

    document.getElementById('startBtn').onclick = () => {
        if(location.protocol!=='https:' && location.hostname!=='localhost') return alert('Тільки HTTPS!');
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        setTimeout(()=>{document.getElementById('scene').classList.remove('hidden');
                       document.getElementById('loading').classList.add('hidden');},800);
    };

    // Зірочка знайдена → вмикаємо звук ельфа (він вже «там»)
    document.querySelector('#starAnchor').addEventListener('targetFound', () => {
        if (step !== 1) return;
        step = 2;
        hint.textContent = "Я десь поруч… підійди ближче, почуєш!";
        waitingSound.components.sound.playSound();
    });

    // Відстеження відстані саме до ельфа (до elfContainer)
    document.querySelector('a-scene').addEventListener('renderstart', () => {
        const camera = document.querySelector('a-camera').object3D;
        const update = () => {
            if (step === 2 && elfContainer.object3D.visible) {
                const dist = camera.position.distanceTo(
                    elfContainer.object3D.getWorldPosition(new THREE.Vector3())
                );
                if (dist < 0.5) {
                    elfIdle.setAttribute('visible', true);
                    sendBtn.style.display = 'block';
                } else {
                    elfIdle.setAttribute('visible', false);
                    sendBtn.style.display = 'none';
                }
            }
            requestAnimationFrame(update);
        };
        update();
    });

    // Відправка листа
    sendBtn.onclick = () => {
        sendBtn.style.display = 'none';
        elfIdle.setAttribute('visible', false);
        waitingSound.components.sound.stopSound();

        elfMagic.setAttribute('visible', true);
        magicSound.components.sound.playSound();

        hint.textContent = "Я передав твоє бажання Санті! Вітаю з Різдвом!";

        let f = 0;
        const anim = setInterval(() => {
            f++;
            elfMagic.setAttribute('material', 'offsetRepeat', `0 ${-f/36}`);
            if (f >= 36) { clearInterval(anim);
                setTimeout(() => {
                    elfMagic.setAttribute('visible', false);
                    const btn = document.createElement('button');
                    btn.textContent='Заново'; btn.style.cssText='margin-top:20px;padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer';
                    btn.onclick=()=>location.reload();
                    hint.appendChild(document.createElement('br'));
                    hint.appendChild(btn);
                }, 1200);
            }
        }, 80);
    };
</script>
</body>
</html>

