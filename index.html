<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Передай лист Санті</title>

  <!-- Тепер можна з найжорсткішим CSP — unsafe-eval не потрібен! -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdn.jsdelivr.net;
    img-src 'self' https: data:;
    media-src 'self' https:;
    connect-src 'self';
    style-src 'self' 'unsafe-inline';
    object-src 'none';
  ">

  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mindar-image-three@1.2.5/prod/mindar-image-three.prod.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#0a1e3a; font-family:sans-serif; }
    #start, #loading { position:fixed; inset:0; background:linear-gradient(135deg,#0f3443,#1e5a7e);
      display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; z-index:100; text-align:center; }
    h1 { font-size:2.8em; color:#ffd700; text-shadow:0 0 20px gold; margin-bottom:20px; }
    button { background:#e74c3c; color:white; border:none; padding:18px 50px; font-size:1.6em;
      border-radius:50px; cursor:pointer; box-shadow:0 10px 30px rgba(231,76,60,.6); transition:.2s; }
    button:hover { transform:scale(1.05); }
    button:active { transform:scale(0.95); }
    #hint { position:absolute; top:15px; left:50%; transform:translateX(-50%);
      background:#000000cc; padding:12px 30px; border-radius:20px; font-size:1.7em; z-index:10; pointer-events:none; }
    #sendBtn { position:absolute; bottom:90px; left:50%; transform:translateX(-50%);
      background:#27ae60; padding:20px 60px; font-size:2em; border-radius:50px; z-index:20; display:none; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <div id="start">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
  </div>

  <div id="loading" class="hidden">Завантаження...</div>
  <div id="hint">Знайди слід Ельфа!</div>
  <button id="sendBtn">Відправити лист</button>

  <script type="module">
    const startScreen = document.getElementById('start');
    const loading = document.getElementById('loading');
    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    let step = 0;
    let waitingSound, magicSound;
    let elfIdleSprite, elfMagicSprite;

    document.getElementById('startBtn').onclick = async () => {
      startScreen.classList.add('hidden');
      loading.classList.remove('hidden');

      const mindar = new MINDAR.ImageThree({
        container: document.body,
        imageTargetSrc: 'targets.mind',   // твій файл залишився!
        maxTrack: 2,
        uiLoading: 'no',
        uiScanning: 'no'
      });

      const { scene, camera, renderer } = await mindar.start();
      loading.classList.add('hidden');

      const light = new THREE.HemisphereLight(0xffffff, 0x4444ff, 2);
      scene.add(light);

      const listener = new THREE.AudioListener();
      camera.add(listener);

      // === Спрайти ельфа (твої png-файли) ===
      const idleTex = new THREE.TextureLoader().load('elf-idle.png');
      idleTex.wrapS = idleTex.wrapT = THREE.RepeatWrapping;
      idleTex.repeat.set(1, 1/24);

      const magicTex = new THREE.TextureLoader().load('elf-magic.png');
      magicTex.wrapS = magicTex.wrapT = THREE.RepeatWrapping;
      magicTex.repeat.set(1, 1/36);

      const idleMaterial = new THREE.SpriteMaterial({ map: idleTex, transparent: true });
      const magicMaterial = new THREE.SpriteMaterial({ map: magicTex, transparent: true });

      elfIdleSprite = new THREE.Sprite(idleMaterial);
      elfIdleSprite.scale.set(0.8, 1.6, 1);
      elfIdleSprite.position.set(1.4, 1.1, -0.8);
      elfIdleSprite.visible = false;

      elfMagicSprite = new THREE.Sprite(magicMaterial);
      elfMagicSprite.scale.set(0.8, 1.6, 1);
      elfMagicSprite.position.copy(elfIdleSprite.position);
      elfMagicSprite.visible = false;

      // === Маркер 0 — дзвіночок ===
      const bellAnchor = mindar.addAnchor(0);
      bellAnchor.onTargetFound = () => {
        if (step === 0) {
          step = 1;
          hint.textContent = "Чудово! Тепер другий слід!";
        }
      };

      // === Маркер 1 — зірочка (ельф) ===
      const starAnchor = mindar.addAnchor(1);
      starAnchor.group.add(elfIdleSprite);
      starAnchor.group.add(elfMagicSprite);

      // Звуки
      const soundPos = new THREE.Object3D();
      soundPos.position.copy(elfIdleSprite.position);
      starAnchor.group.add(soundPos);

      waitingSound = new THREE.PositionalAudio(listener);
      magicSound = new THREE.PositionalAudio(listener);
      soundPos.add(waitingSound);
      soundPos.add(magicSound);

      new THREE.AudioLoader().load('waiting.mp3', buf => { waitingSound.setBuffer(buf); waitingSound.setRefDistance(0.4); });
      new THREE.AudioLoader().load('magic-sound.mp3', buf => { magicSound.setBuffer(buf); magicSound.setRefDistance(0.3); });

      const clock = new THREE.Clock();

      starAnchor.onTargetFound = () => {
        if (step !== 1) return;
        step = 2;
        hint.textContent = "Я десь поруч… підійди ближче, почуєш!";
        waitingSound.setLoop(true);
        waitingSound.play();
        renderer.setAnimationLoop(animate);
      };

      starAnchor.onTargetLost = () => {
        sendBtn.style.display = 'none';
        elfIdleSprite.visible = false;
        if (waitingSound.isPlaying) waitingSound.stop();
      };

      function animate() {
        const delta = clock.getDelta();

        // Відстань до камери
        const worldPos = new THREE.Vector3();
        elfIdleSprite.getWorldPosition(worldPos);
        const dist = camera.position.distanceTo(worldPos);

        // Гучність звуку
        if (waitingSound.isPlaying) {
          const vol = Math.max(0.1, 1 - dist/4);
          waitingSound.setVolume(vol);
        }

        // Показати ельфа коли близько
        const near = dist < 0.7;
        elfIdleSprite.visible = near;
        sendBtn.style.display = near ? 'block' : 'none';

        // Анімація idle (24 кадри, 2.88 сек)
        idleTex.offset.y = (idleTex.offset.y - delta / 2.88) % 1;

        // Анімація магії (якщо запущена)
        if (elfMagicSprite.visible) {
          magicTex.offset.y = (magicTex.offset.y - delta / 2.88) % 1;
        }

        renderer.render(scene, camera);
      }

      sendBtn.onclick = () => {
        step = 3;
        sendBtn.style.display = 'none';
        elfIdleSprite.visible = false;
        waitingSound.stop();

        elfMagicSprite.visible = true;
        magicSound.play();

        hint.innerHTML = "Я передав твоє бажання Санті!<br>Вітаю з Різдвом!";

        setTimeout(() => {
          const restart = document.createElement('button');
          restart.textContent = 'Заново';
          restart.style.marginTop = '30px';
          restart.style.background = '#27ae60';
          restart.onclick = () => location.reload();
          hint.appendChild(restart);
        }, 4000);
      };
    };
  </script>
</body>
</html>
