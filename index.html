<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Magic Christmas Sock ‚Äî 3D-Like Try-On</title>

<!-- Mediapipe Pose & Camera -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.5/camera_utils.js"></script>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#fbf7f2;
    --panel:#fffaf4;
    --accent:#e7d6c4;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  #app{
    position:relative;
    width:100%;
    height:100vh;
    overflow:hidden;
  }

  video#camera {
    position: absolute;
    top:0; left:0;
    width:100%; height:100%;
    object-fit:cover;
    transform: scaleX(-1);
    display:none;
  }

  canvas#three-canvas{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    display:block;
    transform: scaleX(-1);
  }

  canvas#snow-canvas{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
    z-index:6;
    mix-blend-mode:screen;
  }

  .ui{
    position: absolute;
    z-index: 10;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    display:flex;
    gap:12px;
    align-items:center;
  }

  .btn{
    background:var(--panel);
    border:1px solid var(--accent);
    padding:10px 14px;
    border-radius:12px;
    font-size:15px;
    cursor:pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  }
  .btn:active{transform:translateY(1px);}

  .top-left{
    position:absolute;
    top:14px; left:14px; z-index:10;
    background:rgba(255,255,255,0.8);
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--accent);
    font-size:14px;
  }

  .hint{
    position:absolute;
    top:14px; right:14px; z-index:10;
    background:rgba(255,250,245,0.9);
    padding:6px 10px;border-radius:10px;border:1px solid var(--accent);
    font-size:13px;
  }

  @media (max-width:600px){
    .btn{font-size:14px;padding:10px;}
    .top-left,.hint{font-size:12px}
  }
</style>
</head>
<body>
<div id="app">
  <video id="camera" playsinline></video>
  <canvas id="three-canvas"></canvas>
  <canvas id="snow-canvas"></canvas>

  <div class="top-left">Magic Sock AR ‚Äî Try it on your foot üë£</div>
  <div class="hint">Allow camera ‚Üí point your foot into view ‚Üí press üì∏ to save</div>

  <div class="ui">
    <button id="changeBtn" class="btn">üß¶ Change Design</button>
    <button id="saveBtn" class="btn">üì∏ Save Photo</button>
    <button id="flipBtn" class="btn">üîÅ Flip Foot</button>
  </div>
</div>

<script>
/*
  === –í–ê–®–Ü PNG-–¢–ï–ö–°–¢–£–†–ò ===
  –ü–æ–∫–ª–∞–¥—ñ—Ç—å —Ñ–∞–π–ª–∏: sock1.png, sock2.png, sock3.png... –ø–æ—Ä—É—á –∑ —Ü–∏–º index.html
  –£—Å—ñ –ø–æ–≤–∏–Ω–Ω—ñ –º–∞—Ç–∏ –ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω —ñ –±—É—Ç–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 512√ó1024 px)
*/
const sockPNGs = [
  'sock1.png',
  'sock2.png',
  'sock3.png'
  // –î–æ–¥–∞–π—Ç–µ –±—ñ–ª—å—à–µ, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ: 'sock4.png', ...
];

// --- –ü–ï–†–ï–í–Ü–†–ö–ê –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø THREE.JS ---
if (typeof THREE === 'undefined') {
  alert('Error: Three.js failed to load. Please check your internet connection and reload the page.');
  throw new Error('THREE is not defined');
}

// --- Three.js setup ---
const video = document.getElementById('camera');
const threeCanvas = document.getElementById('three-canvas');
const snowCanvas = document.getElementById('snow-canvas');
threeCanvas.width = window.innerWidth;
threeCanvas.height = window.innerHeight;
snowCanvas.width = window.innerWidth;
snowCanvas.height = window.innerHeight;

const scene = new THREE.Scene();
const camera3 = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 10);
camera3.position.z = 1;
const renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, alpha: true, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio || 1);

const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9);
scene.add(hemi);

// –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–º–Ω—É —à–∫–∞—Ä–ø–µ—Ç–∫—É
let texLoader = new THREE.TextureLoader();
let currentDesign = 0;
const designsCount = sockPNGs.length;

// –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–µ—Ä—à—É —Ç–µ–∫—Å—Ç—É—Ä—É
let sockMaterial = new THREE.MeshBasicMaterial({
  map: texLoader.load(sockPNGs[0]),
  transparent: true,
  side: THREE.DoubleSide,
  depthTest: true
});

// –ì—Ä—É–ø–∞ –¥–ª—è —à–∫–∞—Ä–ø–µ—Ç–∫–∏
let sockGroup = new THREE.Group();

// –ì–æ–ª—ñ–Ω–Ω—è ‚Äî —Ü–∏–ª—ñ–Ω–¥—Ä
const leg = new THREE.Mesh(
  new THREE.CylinderGeometry(0.095, 0.11, 0.32, 16),
  sockMaterial
);
leg.position.y = 0.18;

// –ù–æ—Å–æ–∫ ‚Äî –ø—ñ–≤–∫—É–ª—è (–Ω–∏–∂–Ω—è —á–∞—Å—Ç–∏–Ω–∞ —Å—Ñ–µ—Ä–∏)
const toe = new THREE.Mesh(
  new THREE.SphereGeometry(0.1, 12, 12, 0, Math.PI * 2, 0, Math.PI / 2),
  sockMaterial
);
toe.position.y = -0.02;
toe.rotation.x = Math.PI;

sockGroup.add(leg, toe);
sockGroup.scale.x = -1; // –¥–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
scene.add(sockGroup);

// --- –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è: Mediapipe ‚Üí Three.js –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ ---
function mpToThree(x, y) {
  const nx = (x - 0.5) * 2;
  const ny = -(y - 0.5) * 2;
  return { x: nx * (window.innerWidth / window.innerHeight), y: ny };
}

// --- Mediapipe Pose ---
const pose = new Pose.Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}` });
pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults(onPoseResults);

const cameraUtils = window.Camera;
const cam = new cameraUtils(video, {
  onFrame: async () => { await pose.send({ image: video }); },
  width: 640,
  height: 480
});

async function startCamera() {
  try {
    await cam.start();
  } catch (e) {
    console.error('Camera start error', e);
    alert('Camera access is required. Please allow camera and reload the page.');
  }
}
startCamera();

function onPoseResults(results) {
  if (!results.poseLandmarks) {
    renderer.render(scene, camera3);
    return;
  }

  const L = results.poseLandmarks;
  // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–æ—á–∫–∏ —Å—Ç–æ–ø–∏ (–ø—Ä–∞–≤–∞/–ª—ñ–≤–∞)
  const rightAnkle = L[27] || L[29] || L[28] || null;
  const rightToe = L[31] || L[32] || L[30] || null;
  const leftAnkle = L[26] || L[25] || L[24] || null;
  const leftToe = L[29] || L[28] || L[27] || null;

  let ankle = rightAnkle || leftAnkle;
  let toePt = rightToe || leftToe;

  // –í–∏–±–∏—Ä–∞—î–º–æ –≤–∏–¥–∏–º—É —Å—Ç–æ–ø—É (–Ω–∏–∂—á—É –Ω–∞ –µ–∫—Ä–∞–Ω—ñ)
  if (rightAnkle && leftAnkle) {
    if (rightAnkle.y > leftAnkle.y) {
      ankle = rightAnkle;
      toePt = rightToe;
    } else {
      ankle = leftAnkle;
      toePt = leftToe;
    }
  }

  if (ankle && toePt) {
    const pAn = mpToThree(ankle.x, ankle.y);
    const pTo = mpToThree(toePt.x, toePt.y);
    const angle = Math.atan2(pTo.y - pAn.y, pTo.x - pAn.x);

    sockGroup.position.x = pAn.x * 0.9;
    sockGroup.position.y = pAn.y * 0.95;
    sockGroup.rotation.z = -angle;

    const dist = Math.hypot(pTo.x - pAn.x, pTo.y - pAn.y);
    const scaleFactor = THREE.MathUtils.clamp(0.6 + dist * 1.2, 0.6, 1.6);
    sockGroup.scale.set(scaleFactor, scaleFactor, 1);
  }

  renderer.render(scene, camera3);
}

// --- –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ ---
document.getElementById('changeBtn').addEventListener('click', () => {
  currentDesign = (currentDesign + 1) % designsCount;
  const newMap = texLoader.load(sockPNGs[currentDesign]);
  sockGroup.traverse(child => {
    if (child.isMesh) {
      child.material.map = newMap;
      child.material.needsUpdate = true;
    }
  });
});

let flipped = true;
document.getElementById('flipBtn').addEventListener('click', () => {
  flipped = !flipped;
  threeCanvas.style.transform = flipped ? 'scaleX(-1)' : 'scaleX(1)';
  video.style.transform = flipped ? 'scaleX(-1)' : 'scaleX(1)';
});

document.getElementById('saveBtn').addEventListener('click', async () => {
  // Flash-–µ—Ñ–µ–∫—Ç
  const flash = document.createElement('div');
  flash.style.position = 'fixed';
  flash.style.left = flash.style.top = 0;
  flash.style.width = flash.style.height = '100%';
  flash.style.background = '#fff';
  flash.style.opacity = '0.0';
  flash.style.zIndex = '9999';
  document.body.appendChild(flash);
  flash.style.transition = 'opacity 120ms';
  requestAnimationFrame(() => flash.style.opacity = '0.9');
  setTimeout(() => flash.style.opacity = '0.0', 140);
  setTimeout(() => document.body.removeChild(flash), 300);

  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
  html2canvas(document.getElementById('app'), { useCORS: true, scale: window.devicePixelRatio || 1 })
    .then(canvas => {
      const link = document.createElement('a');
      link.download = 'my_magic_sock.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    })
    .catch(err => {
      console.error('Capture failed', err);
      alert('Screenshot failed ‚Äî try again or check browser permissions.');
    });
});

// --- –ï—Ñ–µ–∫—Ç —Å–Ω—ñ–≥—É ---
const sctx = snowCanvas.getContext('2d');
let particles = [];
const P_COUNT = Math.round((window.innerWidth / 100) * 6);

function initSnow() {
  particles = [];
  for (let i = 0; i < P_COUNT; i++) {
    particles.push({
      x: Math.random() * snowCanvas.width,
      y: Math.random() * snowCanvas.height,
      r: 1 + Math.random() * 3,
      dx: (Math.random() - 0.5) * 0.5,
      dy: 0.4 + Math.random() * 1.2,
      phase: Math.random() * 2 * Math.PI
    });
  }
}

function drawSnow() {
  sctx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
  sctx.fillStyle = 'rgba(255,255,255,0.95)';
  for (const p of particles) {
    sctx.beginPath();
    sctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    sctx.fill();
  }
}

function updateSnow(dt) {
  for (const p of particles) {
    p.phase += 0.02 + Math.random() * 0.02;
    p.x += p.dx + Math.sin(p.phase) * 0.3;
    p.y += p.dy;
    if (p.y > snowCanvas.height + 10) {
      p.y = -10;
      p.x = Math.random() * snowCanvas.width;
    }
    if (p.x < -10) p.x = snowCanvas.width + 10;
    if (p.x > snowCanvas.width + 10) p.x = -10;
  }
}

let last = performance.now();
function animate(t) {
  const dt = (t - last) / 1000;
  last = t;
  updateSnow(dt);
  drawSnow();
  requestAnimationFrame(animate);
}
initSnow();
animate();

// --- –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –≥—ñ–¥ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ---
(function showGuide() {
  const guide = document.createElement('div');
  guide.style.position = 'absolute';
  guide.style.left = '50%';
  guide.style.top = '50%';
  guide.style.transform = 'translate(-50%, -50%)';
  guide.style.zIndex = '11';
  guide.style.background = 'rgba(255,250,245,0.9)';
  guide.style.padding = '10px 16px';
  guide.style.border = '1px solid var(--accent)';
  guide.style.borderRadius = '12px';
  guide.style.fontSize = '15px';
  guide.style.textAlign = 'center';
  guide.innerText = 'Point your foot into the camera view ‚Äî the magic sock will follow üë£';
  document.body.appendChild(guide);
  setTimeout(() => {
    guide.style.transition = 'opacity 500ms';
    guide.style.opacity = '0';
    setTimeout(() => document.body.removeChild(guide), 600);
  }, 4200);
})();
</script>
</body>
</html>
