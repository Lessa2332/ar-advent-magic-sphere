<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Magical Snow Globe AR</title>
  <!-- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ URL –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤ -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
      touch-action: none;
    }
    .container {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    #ar-container {
      width: 100%;
      height: 100%;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      color: white;
      background: rgba(0,0,0,0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid #4a90e2;
      min-width: 280px;
    }
    .loading h3 {
      margin: 0 0 15px 0;
      color: #4a90e2;
    }
    .loading p {
      margin: 8px 0;
      font-size: 16px;
    }
    .loading .small {
      font-size: 14px;
      color: #ccc;
    }
    .error {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 1001;
      color: red;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 8px;
      display: none;
      border: 1px solid red;
    }
    .music-control {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1002;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      border: 2px solid #4a90e2;
    }
    .music-control:hover {
      background: rgba(74, 144, 226, 0.3);
    }
    .music-control.playing {
      background: rgba(74, 144, 226, 0.5);
    }
  </style>
</head>
<body>
  <div class="error" id="error"></div>
  <button class="music-control" id="musicButton" aria-label="–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É">üîá –£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É</button>
  <div class="loading" id="loading">
    <h3>üîÆ –ú–∞–≥—ñ—á–Ω–∞ –∫—É–ª—è</h3>
    <p><strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</strong></p>
    <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
    <p class="small">–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</p>
  </div>
  <!-- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–¥–∞–Ω–æ cursor + raycaster –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –∫–ª—ñ–∫—É –Ω–∞ 3D-–æ–±'—î–∫—Ç–∞—Ö -->
  <a-scene
    id="scene"
    embedded
    mindar-image="imageTargetSrc: ./card.mind; autoStart: true; maxTrack: 1;"
    color-space="sRGB"
    renderer="colorManagement: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    cursor="rayOrigin: mouse"
    raycaster="objects: .clickable">
    <!-- –ê—É–¥—ñ–æ -->
    <a-assets timeout="8000">
      <!-- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–¥–∞–Ω–æ loop –¥–æ <audio> –¥–ª—è —Ü–∏–∫–ª—ñ—á–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è -->
      <audio id="backgroundMusic" src="./fon1.mp3" preload="auto" loop crossorigin></audio>
    </a-assets>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <!-- ‚úÖ –ó–∞–ª–∏—à–µ–Ω–æ loop: true —É sound –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ -->
    <a-entity id="background-audio" sound="src: #backgroundMusic; volume: 0.5; loop: true"></a-entity>
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- ‚úÖ –ö—É–ª—è –∑ –∫–ª–∞—Å–æ–º clickable -->
      <a-sphere
        id="magic-sphere"
        radius="0.4"
        position="0 0.5 0"
        color="#aaddff"
        opacity="0.4"
        transparent="true"
        shader="flat"
        class="clickable">
      </a-sphere>
      <!-- –ü—ñ–¥—Å—Ç–∞–≤–∫–∞ -->
      <a-cylinder
        radius="0.45"
        height="0.05"
        position="0 -0.1 0"
        color="#888888"
        opacity="0.8">
      </a-cylinder>
      <!-- ‚úÖ –¢–µ–∫—Å—Ç –∑ look-at —ñ –≤–∏–¥–∏–º—ñ—Å—Ç—é -->
      <a-text
        id="magic-text"
        value="–¢–æ—Ä–∫–Ω–∏—Å—è –∫—É–ª—ñ!"
        position="0 1.0 0"
        align="center"
        color="#ffffff"
        width="2.5"
        look-at="[camera]"
        visible="true">
      </a-text>
    </a-entity>
  </a-scene>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loading = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const musicButton = document.getElementById('musicButton');
      const scene = document.getElementById('scene');
      let isMusicPlaying = false;
      let audioEntity = null;
      let isRotating = false;
      let snowflakes = [];
      let animationId = null;
      let snowSystem = null;
      const texts = [
        "–ë–∞–∂–∞—é —É–¥–∞—á—ñ!", "–¢–≤–æ—è –º—Ä—ñ—è –∑–±—É–¥–µ—Ç—å—Å—è", "–ú–∞–≥—ñ—è –ø–æ—Ä—É—á", "–°—è–π —è—Å–∫—Ä–∞–≤—ñ—à–µ",
        "–ú—Ä—ñ–π —Å–º—ñ–ª–∏–≤—ñ—à–µ", "–•–æ–ª–æ–¥–Ω–∞ –ø—Ä–∞–≤–¥–∞", "–ì–∞—Ä—è—á–µ –±–∞–∂–∞–Ω–Ω—è", "–ß–∏—Å—Ç—ñ –¥—É–º–∫–∏",
        "–ó–º—ñ–Ω–Ω–∏–π –≤—ñ—Ç–µ—Ä", "–¢–∞—î–º–Ω–∏—á–∞ –Ω—ñ—á", "–Ø—Å–Ω–∏–π –¥–µ–Ω—å", "–®–≤–∏–¥–∫–∞ –¥—ñ—è",
        "–ß–∞—Ä—ñ–≤–Ω–∞ —Å–∏–ª–∞", "–í—ñ—â—É–π –º–∞–π–±—É—Ç–Ω—î", "–°–≤—è—Ç–∫–æ–≤–∏–π –Ω–∞—Å—Ç—Ä—ñ–π"
      ];
      let currentTextIndex = 0;
      // –ü–æ–∫–∞–∑ –ø–æ–º–∏–ª–∫–∏
      function showError(msg) {
        if (errorEl) {
          errorEl.textContent = `‚ùå ${msg}`;
          errorEl.style.display = 'block';
        }
        console.error(msg);
      }
      // –ú—É–∑–∏–∫–∞
      function setupMusicControl() {
        musicButton.addEventListener('click', () => {
          const audioEl = document.getElementById('backgroundMusic');
          if (!audioEntity) {
            audioEntity = document.querySelector('#background-audio');
          }
          if (!audioEl || !audioEntity?.components?.sound) {
            showError('–ê—É–¥—ñ–æ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
            return;
          }
          if (audioEl.readyState < 2) {
            showError('–ú—É–∑–∏–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...');
            return;
          }
          if (isMusicPlaying) {
            audioEntity.components.sound.stopSound();
            musicButton.textContent = 'üîá –£–≤—ñ–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É';
            musicButton.classList.remove('playing');
          } else {
            audioEntity.components.sound.playSound();
            musicButton.textContent = 'üîä –í–∏–º–∫–Ω—É—Ç–∏ –º—É–∑–∏–∫—É';
            musicButton.classList.add('playing');
          }
          isMusicPlaying = !isMusicPlaying;
        });
      }
      // ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å–Ω—ñ–∂–∏–Ω–∫–∏ –∑ –æ—á–∏—â–µ–Ω–Ω—è–º –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É targetFound
      function createSnowflakes() {
        const target = document.querySelector('a-entity[mindar-image-target="targetIndex: 0"]');
        if (!target) {
          console.error('–¢–∞—Ä–≥–µ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
          return;
        }
        // ‚úÖ –î–æ–¥–∞–Ω–æ: –æ—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö —Å–Ω—ñ–∂–∏–Ω–æ–∫
        if (snowSystem) {
          snowSystem.parentNode.removeChild(snowSystem);
          snowflakes = [];
          snowSystem = null;
        }
        snowSystem = document.createElement('a-entity');
        snowSystem.setAttribute('position', '0 0.5 0');
        target.appendChild(snowSystem);
        for (let i = 0; i < 30; i++) {
          const flake = document.createElement('a-sphere');
          const size = 0.008 + Math.random() * 0.015;
          const x = (Math.random() - 0.5) * 0.7;
          const y = (Math.random() - 0.5) * 0.7;
          const z = (Math.random() - 0.5) * 0.7;
          flake.setAttribute('radius', size);
          flake.setAttribute('color', 'white');
          flake.setAttribute('opacity', 0.7);
          flake.setAttribute('position', `${x} ${y} ${z}`);
          flake.dataset.speed = (0.1 + Math.random() * 0.2).toString();
          flake.dataset.angle = (Math.random() * Math.PI * 2).toString();
          flake.dataset.initialX = x.toString();
          flake.dataset.initialZ = z.toString();
          snowSystem.appendChild(flake);
          snowflakes.push(flake);
        }
      }
      // ‚úÖ –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–Ω—ñ–∂–∏–Ω–æ–∫ (—Ü–µ–Ω—Ç—Ä –∫—É–ª—ñ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π: dy = newY, –±–æ newY ‚Äî –≤—ñ–¥–Ω–æ—Å–Ω–æ —Ü–µ–Ω—Ç—Ä—É)
      function animateSnow(timestamp) {
        if (snowflakes.length === 0 || document.hidden) {
          animationId = requestAnimationFrame(animateSnow);
          return;
        }
        const time = timestamp * 0.001;
        const maxRadius = 0.38;
        for (let i = 0; i < snowflakes.length; i++) {
          const flake = snowflakes[i];
          const speed = parseFloat(flake.dataset.speed);
          const angle = parseFloat(flake.dataset.angle);
          const [currX, currY, currZ] = flake.getAttribute('position').split(' ').map(parseFloat);
          let newY = currY - 0.008 * speed;
          if (newY < -0.35) newY = 0.35;
          const initialX = parseFloat(flake.dataset.initialX);
          const initialZ = parseFloat(flake.dataset.initialZ);
          const swingX = Math.sin(time * speed + angle) * 0.012;
          const swingZ = Math.cos(time * speed * 0.8 + angle) * 0.012;
          let newX = initialX + swingX;
          let newZ = initialZ + swingZ;
          // ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ü–µ–Ω—Ç—Ä –∫—É–ª—ñ –≤ (0, 0, 0) –≤—ñ–¥–Ω–æ—Å–Ω–æ snowSystem, —Ç–æ–º—É dy = newY (–±–µ–∑ -0.5)
          const dx = newX;
          const dy = newY;
          const dz = newZ;
          const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
          if (dist > maxRadius) {
            const scale = maxRadius / dist * 0.98;
            newX = dx * scale;
            newZ = dz * scale;
            newY = dy * scale;
          }
          flake.setAttribute('position', `${newX} ${newY} ${newZ}`);
          flake.setAttribute('rotation',
            `${time * 20 * speed} ${time * 30 * speed} ${time * 25 * speed}`
          );
          const flicker = 0.5 + Math.sin(time * 3 + angle) * 0.3;
          flake.setAttribute('opacity', (0.5 * flicker).toFixed(2));
          flake.dataset.angle = (angle + 0.01).toString();
        }
        animationId = requestAnimationFrame(animateSnow);
      }
      // ‚úÖ –ù–∞–¥—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –∑ raycaster + direct listeners
      function setupClickHandler() {
        const sphere = document.getElementById('magic-sphere');
        const text = document.getElementById('magic-text');
        if (!sphere || !text) {
          setTimeout(setupClickHandler, 500);
          return;
        }
        const handleClick = () => {
          if (isRotating) return;
          isRotating = true;
          text.setAttribute('look-at', null);
          text.setAttribute('animation__rotate', {
            property: 'rotation',
            to: `0 ${parseInt(text.getAttribute('rotation').y || 0) + 360} 0`,
            dur: 800,
            easing: 'easeInOutQuad'
          });
          setTimeout(() => {
            currentTextIndex = (currentTextIndex + 1) % texts.length;
            text.setAttribute('value', texts[currentTextIndex]);
            text.setAttribute('look-at', '[camera]');
            isRotating = false;
          }, 800);
        };
        sphere.addEventListener('click', handleClick);
        sphere.addEventListener('touchstart', (e) => {
          e.preventDefault();
          handleClick();
        });
      }
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
      if (!navigator.mediaDevices?.getUserMedia) {
        showError('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è. –°–ø—Ä–æ–±—É–π—Ç–µ Chrome –∞–±–æ Safari.');
      }
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        showError('–ü–æ—Ç—Ä—ñ–±–µ–Ω HTTPS (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, GitHub Pages).');
      }
      // ‚úÖ –ì–æ–ª–æ–≤–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
      if (!scene) {
        showError('–°—Ü–µ–Ω–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞');
        return;
      }
      scene.addEventListener('loaded', () => {
        console.log('‚úÖ AR –≥–æ—Ç–æ–≤–∏–π');
        setTimeout(() => {
          if (loading.style.display !== 'none') {
            loading.style.display = 'none';
          }
        }, 2000);
        setupMusicControl();
        scene.addEventListener('targetFound', () => {
          console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ');
          if (loading.style.display !== 'none') loading.style.display = 'none';
          createSnowflakes(); // ‚úÖ –¢–µ–ø–µ—Ä –∑ –æ—á–∏—â–µ–Ω–Ω—è–º
          if (animationId === null) {
            animationId = requestAnimationFrame(animateSnow);
          }
        });
        scene.addEventListener('targetLost', () => {
          console.log('‚ùå –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ');
          if (animationId !== null) {
            cancelAnimationFrame(animationId);
            animationId = null;
          }
        });
        setTimeout(setupClickHandler, 1200);
      });
      scene.addEventListener('error', (e) => {
        showError('AR –ø–æ–º–∏–ª–∫–∞: ' + (e.detail?.message || '–Ω–µ–≤—ñ–¥–æ–º–∞'));
      });
    });
  </script>
</body>
</html>
