<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Передай лист Санті</title>
    <style>
        body { margin:0; overflow:hidden; background:#0a1e3a; color:white; font-family:sans-serif; }
        .hidden { display:none !important; }
        #startScreen { position:fixed; inset:0; background:linear-gradient(135deg,#0f3443,#1e5a7e); display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; z-index:100; }
        h1 { font-size:2.8em; color:#ffd700; text-shadow:0 0 20px gold; margin-bottom:20px; }
        button { background:#e74c3c; color:white; border:none; padding:18px 50px; font-size:1.6em; border-radius:50px; margin-top:30px; box-shadow:0 10px 30px rgba(231,76,60,.6); cursor:pointer; transition:0.2s; }
        button:active { transform:scale(0.95); }
        #arContainer { position:fixed; inset:0; }
        #hint { position:absolute; top:15px; left:50%; transform:translateX(-50%); background:#000000cc; padding:12px 30px; border-radius:20px; font-size:1.7em; z-index:10; pointer-events:none; text-align:center; max-width:90%; }
        #sendBtn { position:absolute; bottom:90px; left:50%; transform:translateX(-50%); padding:20px 60px; font-size:2em; background:#27ae60; border-radius:50px; z-index:20; display:none; }
        #elfIdle, #elfMagic { position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:85vw; max-width:400px; height:auto; max-height:75vh; background-size:100% auto; background-repeat:no-repeat; background-position:center bottom; pointer-events:none; opacity:0; transition:opacity 1.3s ease; z-index:5; }
        #elfMagic { z-index:6; }
        .loading { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:1.8em; background:#000000dd; padding:20px 40px; border-radius:20px; z-index:999; }
    </style>
</head>
<body>

<div id="startScreen">
    <h1>Передай лист Санті</h1>
    <p>Напиши бажання на папері — і віддай його ельфу!</p>
    <button id="startBtn">Почати</button>
</div>

<div id="arContainer" class="hidden">
    <div id="hint">Знайди дзвіночок!</div>
    <button id="sendBtn">Відправити лист</button>
    <div id="elfIdle"></div>
    <div id="elfMagic"></div>
</div>

<div id="loading" class="loading hidden">Завантаження...</div>

<!-- 100% РОБОЧІ БІБЛІОТЕКИ (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"></script>

<script>
document.getElementById('startBtn').addEventListener('click', async () => {
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        alert('Потрібен HTTPS!');
        return;
    }

    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('arContainer').classList.remove('hidden');
    document.getElementById('loading').classList.remove('hidden');

    const required = ['targets.mind', 'elf-idle.png', 'elf-magic.png', 'waiting.mp3', 'magic-sound.mp3'];
    for (const file of required) {
        try { await fetch(file, {method: 'HEAD'}); } 
        catch { alert(`Не знайдено файл: ${file}`); location.reload(); return; }
    }

    const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.getElementById('arContainer'),
        imageTargetSrc: 'targets.mind',
        uiLoading: 'no',
        uiScanning: 'no'
    });

    const {renderer, scene, camera} = mindarThree;
    const listener = new THREE.AudioListener();
    camera.add(listener);

    const posAudio = new THREE.PositionalAudio(listener);
    posAudio.setRefDistance(0.8);
    posAudio.setMaxDistance(10);
    posAudio.setLoop(true);
    posAudio.setBuffer(await new THREE.AudioLoader().loadAsync('waiting.mp3'));

    let magicSound = new Audio('magic-sound.mp3');
    magicSound.volume = 0.9;

    const anchor1 = mindarThree.addAnchor(0);
    const anchor2 = mindarThree.addAnchor(1);
    let step = 0;

    const hint = document.getElementById('hint');
    const sendBtn = document.getElementById('sendBtn');
    const elfIdle = document.getElementById('elfIdle');
    const elfMagic = document.getElementById('elfMagic');

    anchor1.onTargetFound = () => { if (step === 0) { step = 1; hint.textContent = "Чудово! Тепер зірочку!"; } };
    anchor2.onTargetFound = () => {
        if (step !== 1) return;
        const lift = new THREE.Group(); lift.position.y = 1.0; anchor2.group.add(lift);
        const audioLift = new THREE.Group(); audioLift.position.y = 1.0; audioLift.add(posAudio); anchor2.group.add(audioLift);
        posAudio.play();
        hint.textContent = "Я тут, чекаю твого листа…";
        step = 2;
    };

    let frame = 0;
    const idleAnim = setInterval(() => {
        if (elfIdle.style.opacity > 0) {
            frame = (frame + 1) % 30;
            elfIdle.style.backgroundPosition = `center ${-frame * (100/30)}%`;
        }
    }, 100);

    renderer.setAnimationLoop(() => {
        if (step === 2 && anchor2.group) {
            const camPos = new THREE.Vector3(); camera.getWorldPosition(camPos);
            const elfPos = anchor2.group.getWorldPosition(new THREE.Vector3()); elfPos.y += 1.0;
            const dist = camPos.distanceTo(elfPos);
            posAudio.setVolume(Math.max(0.1, 1 - dist/5));

            if (dist < 0.5 && elfIdle.style.opacity == 0) {
                elfIdle.style.background = 'url("elf-idle.png") center bottom / 100% auto no-repeat';
                elfIdle.style.opacity = 1;
                sendBtn.style.display = 'block';
            }
        }
        renderer.render(scene, camera);
    });

    sendBtn.onclick = () => {
        sendBtn.style.display = 'none';
        elfIdle.style.opacity = 0;
        clearInterval(idleAnim);
        if (posAudio.isPlaying) posAudio.stop();

        elfMagic.style.background = 'url("elf-magic.png") center bottom / 100% auto no-repeat';
        elfMagic.style.opacity = 1;

        magicSound.currentTime = 0;
        magicSound.play();

        hint.textContent = "Я передав твоє бажання Санті! Вітаю з Різдвом!";

        let f = 0;
        const anim = setInterval(() => {
            f++;
            if (f >= 36) {
                clearInterval(anim);
                setTimeout(() => {
                    elfMagic.style.opacity = 0;
                    hint.innerHTML = 'Я передав твоє бажання Санті!<br><br><button onclick="location.reload()" style="padding:15px 50px;font-size:1.6em;background:#27ae60;border:none;border-radius:50px;cursor:pointer">Розпочати знову</button>';
                }, 1000);
            } else {
                elfMagic.style.backgroundPosition = `center ${-f * (100/36)}%`;
            }
        }, 80);
    };

    await mindarThree.start();
    document.getElementById('loading').classList.add('hidden');
});
</script>
</body>
</html>
